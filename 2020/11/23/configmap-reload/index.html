<!DOCTYPE html><html lang="zh-CN"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v4.16.19"><meta name="description" content="Configmap Reload"><title>Configmap Reload</title><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet"><link rel="stylesheet" href="/_astro/_title_.8kzbYMPX.css"><script type="module">const e=()=>{document.querySelectorAll(".animate").forEach((t,s)=>{setTimeout(()=>{t.classList.add("show")},s*150)})};e();document.addEventListener("astro:after-swap",e);
</script></head> <body> <header> <div class="mx-auto max-w-screen-sm px-5">  <div class="flex flex-wrap gap-y-2 justify-between"> <a href="/" class="font-semibold hover:underline underline-offset-2">
Blog
</a> <nav class="flex gap-1">  <a href="/archive" class="hover:underline underline-offset-2"> Archive </a> <span>/</span> <a href="/about" class="hover:underline underline-offset-2"> About </a>  </nav> </div>  </div> </header> <main>  <div class="mx-auto max-w-screen-sm px-5">  <div class="animate"> <a href="/archive" class="hover:underline underline-offset-2">
← Back to archive
</a> </div> <div class="space-y-1 my-10"> <div class="animate flex items-center gap-1.5"> <div class="font-base text-sm"> <time datetime="2020-11-23T11:05:58.000Z"> November 23, 2020 </time> </div> </div> <div class="animate text-2xl font-semibold text-black dark:text-white"> Configmap Reload </div> <div class="animate flex flex-wrap gap-2 mt-4"> <span class="text-xs px-2 py-1 rounded bg-stone-200 dark:bg-stone-800"> k8s </span> </div> </div> <article class="animate"> <p><a href="https://github.com/jimmidyson/configmap-reload">repo链接</a></p>
<p>It watches mounted volume dirs and notifies the target process that the config map has been changed. It currently only supports sending an HTTP request, but in future it is expected to support sending OS (e.g. SIGHUP) once Kubernetes supports pod PID namespaces.</p>
<p>主要是利用fsnotify的方式</p>
<p>比较好的基于重试的写法</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#E1E4E8">begun </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> time.</span><span style="color:#B392F0">Now</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">req, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> http.</span><span style="color:#B392F0">NewRequest</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">webhookMethod, h.</span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">(), </span><span style="color:#79B8FF">nil</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">  setFailureMetrics</span><span style="color:#E1E4E8">(h.</span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">(), </span><span style="color:#9ECBFF">"client_request_create"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">  log.</span><span style="color:#B392F0">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"error:"</span><span style="color:#E1E4E8">, err)</span></span>
<span class="line"><span style="color:#F97583">  continue</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#E1E4E8">userInfo </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> h.User</span></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> userInfo </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> password, passwordSet </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> userInfo.</span><span style="color:#B392F0">Password</span><span style="color:#E1E4E8">(); passwordSet {</span></span>
<span class="line"><span style="color:#E1E4E8">    req.</span><span style="color:#B392F0">SetBasicAuth</span><span style="color:#E1E4E8">(userInfo.</span><span style="color:#B392F0">Username</span><span style="color:#E1E4E8">(), password)</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">successfulReloadWebhook </span><span style="color:#F97583">:=</span><span style="color:#79B8FF"> false</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">for</span><span style="color:#E1E4E8"> retries </span><span style="color:#F97583">:=</span><span style="color:#F97583"> *</span><span style="color:#E1E4E8">webhookRetries; retries </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; retries</span><span style="color:#F97583">--</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">  log.</span><span style="color:#B392F0">Printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"performing webhook request (</span><span style="color:#79B8FF">%d</span><span style="color:#9ECBFF">/</span><span style="color:#79B8FF">%d</span><span style="color:#9ECBFF">)"</span><span style="color:#E1E4E8">, retries, </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">webhookRetries)</span></span>
<span class="line"><span style="color:#E1E4E8">  resp, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> http.DefaultClient.</span><span style="color:#B392F0">Do</span><span style="color:#E1E4E8">(req)</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">    setFailureMetrics</span><span style="color:#E1E4E8">(h.</span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">(), </span><span style="color:#9ECBFF">"client_request_do"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    log.</span><span style="color:#B392F0">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"error:"</span><span style="color:#E1E4E8">, err)</span></span>
<span class="line"><span style="color:#E1E4E8">    time.</span><span style="color:#B392F0">Sleep</span><span style="color:#E1E4E8">(time.Second </span><span style="color:#F97583">*</span><span style="color:#79B8FF"> 10</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    continue</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">  resp.Body.</span><span style="color:#B392F0">Close</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">  requestsByStatusCode.</span><span style="color:#B392F0">WithLabelValues</span><span style="color:#E1E4E8">(h.</span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">(), strconv.</span><span style="color:#B392F0">Itoa</span><span style="color:#E1E4E8">(resp.StatusCode)).</span><span style="color:#B392F0">Inc</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> resp.StatusCode </span><span style="color:#F97583">!=</span><span style="color:#F97583"> *</span><span style="color:#E1E4E8">webhookStatusCode {</span></span>
<span class="line"><span style="color:#B392F0">    setFailureMetrics</span><span style="color:#E1E4E8">(h.</span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">(), </span><span style="color:#9ECBFF">"client_response"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    log.</span><span style="color:#B392F0">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"error:"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"Received response code"</span><span style="color:#E1E4E8">, resp.StatusCode, </span><span style="color:#9ECBFF">", expected"</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">webhookStatusCode)</span></span>
<span class="line"><span style="color:#E1E4E8">    time.</span><span style="color:#B392F0">Sleep</span><span style="color:#E1E4E8">(time.Second </span><span style="color:#F97583">*</span><span style="color:#79B8FF"> 10</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    continue</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  setSuccessMetrics</span><span style="color:#E1E4E8">(h.</span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">(), begun)</span></span>
<span class="line"><span style="color:#E1E4E8">  log.</span><span style="color:#B392F0">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"successfully triggered reload"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">  successfulReloadWebhook </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> true</span></span>
<span class="line"><span style="color:#F97583">  break</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#F97583"> !</span><span style="color:#E1E4E8">successfulReloadWebhook {</span></span>
<span class="line"><span style="color:#B392F0">  setFailureMetrics</span><span style="color:#E1E4E8">(h.</span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">(), </span><span style="color:#9ECBFF">"retries_exhausted"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">  log.</span><span style="color:#B392F0">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"error:"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"Webhook reload retries exhausted"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </article>  </div>  </main> <footer class="animate" data-astro-cid-sz7xmlte> <div class="mx-auto max-w-screen-sm px-5">  <div class="flex justify-between items-center" data-astro-cid-sz7xmlte> <div data-astro-cid-sz7xmlte>
&copy; 2026 | Blog
</div> <div class="flex flex-wrap gap-1 items-center" data-astro-cid-sz7xmlte> <button id="light-theme-button" aria-label="Light theme" class="group size-8 flex items-center justify-center rounded-full" data-astro-cid-sz7xmlte> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="group-hover:stroke-black group-hover:dark:stroke-white transition-colors duration-300 ease-in-out" data-astro-cid-sz7xmlte> <circle cx="12" cy="12" r="5" data-astro-cid-sz7xmlte></circle> <line x1="12" y1="1" x2="12" y2="3" data-astro-cid-sz7xmlte></line> <line x1="12" y1="21" x2="12" y2="23" data-astro-cid-sz7xmlte></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" data-astro-cid-sz7xmlte></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" data-astro-cid-sz7xmlte></line> <line x1="1" y1="12" x2="3" y2="12" data-astro-cid-sz7xmlte></line> <line x1="21" y1="12" x2="23" y2="12" data-astro-cid-sz7xmlte></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" data-astro-cid-sz7xmlte></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" data-astro-cid-sz7xmlte></line> </svg> </button> <button id="dark-theme-button" aria-label="Dark theme" class="group size-8 flex items-center justify-center rounded-full" data-astro-cid-sz7xmlte> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="group-hover:stroke-black group-hover:dark:stroke-white transition-colors duration-300 ease-in-out" data-astro-cid-sz7xmlte> <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" data-astro-cid-sz7xmlte></path> </svg> </button> <button id="system-theme-button" aria-label="System theme" class="group size-8 flex items-center justify-center rounded-full" data-astro-cid-sz7xmlte> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="group-hover:stroke-black group-hover:dark:stroke-white transition-colors duration-300 ease-in-out" data-astro-cid-sz7xmlte> <rect x="2" y="3" width="20" height="14" rx="2" ry="2" data-astro-cid-sz7xmlte></rect> <line x1="8" y1="21" x2="16" y2="21" data-astro-cid-sz7xmlte></line> <line x1="12" y1="17" x2="12" y2="21" data-astro-cid-sz7xmlte></line> </svg> </button> </div> </div>  </div> </footer>  <script>
  function setTheme(theme) {
    document.documentElement.classList.remove("light", "dark", "system");
    
    if (theme === "system") {
      document.documentElement.classList.add("system");
      const systemTheme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
      document.documentElement.classList.add(systemTheme);
    } else {
      document.documentElement.classList.add(theme);
    }
    
    localStorage.setItem("theme", theme);
  }

  document.getElementById("light-theme-button")?.addEventListener("click", () => setTheme("light"));
  document.getElementById("dark-theme-button")?.addEventListener("click", () => setTheme("dark"));
  document.getElementById("system-theme-button")?.addEventListener("click", () => setTheme("system"));

  const savedTheme = localStorage.getItem("theme") || "system";
  setTheme(savedTheme);
</script>  </body> </html>