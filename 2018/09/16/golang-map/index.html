<!DOCTYPE html><html lang="zh-CN"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v4.16.19"><meta name="description" content="Blog post"><title>Untitled</title><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet"><link rel="stylesheet" href="/_astro/_title_.8kzbYMPX.css"><script type="module">const e=()=>{document.querySelectorAll(".animate").forEach((t,s)=>{setTimeout(()=>{t.classList.add("show")},s*150)})};e();document.addEventListener("astro:after-swap",e);
</script></head> <body> <header> <div class="mx-auto max-w-screen-sm px-5">  <div class="flex flex-wrap gap-y-2 justify-between"> <a href="/" class="font-semibold hover:underline underline-offset-2">
Blog
</a> <nav class="flex gap-1">  <a href="/archive" class="hover:underline underline-offset-2"> Archive </a> <span>/</span> <a href="/about" class="hover:underline underline-offset-2"> About </a>  </nav> </div>  </div> </header> <main>  <div class="mx-auto max-w-screen-sm px-5">  <div class="animate"> <a href="/archive" class="hover:underline underline-offset-2">
← Back to archive
</a> </div> <div class="space-y-1 my-10"> <div class="animate flex items-center gap-1.5"> <div class="font-base text-sm"> <time datetime="2018-09-16T00:00:00.000Z"> September 16, 2018 </time> </div> </div> <div class="animate text-2xl font-semibold text-black dark:text-white">  </div>  </div> <article class="animate"> <p>title: Golang Map efficiently vs other language
date: 2018-09-16 15:35:13
categories: golang</p>
<h2 id="tags-golang">tags: [golang]</h2>
<p><a href="https://dave.cheney.net/2018/05/29/how-the-go-runtime-implements-maps-efficiently-without-generics">原文链接</a></p>
<p>主要是介绍没有泛型的情况下，hashmap实现上的一些高效考虑</p>
<h3 id="gos-map-is-a-hashmap">Go’s map is a hashmap</h3>
<p>hash function</p>
<ul>
<li>The first is <em>stability</em>. The hash function must be stable. Given the same key, your hash function must return the same answer</li>
<li>The second property is <em>good distribution</em>. Given two near identical keys, the result should be wildly different</li>
</ul>
<p>In this case our hashmap has eight buckets (as this is the value that the Go implementation uses) and each bucket can hold up to eight entries each (again drawn from the Go implementation)</p>
<p><img src="https://dave.cheney.net/wp-content/uploads/2018/05/Gocon-2018-Maps.021-624x351.png" alt=""></p>
<p><img src="https://dave.cheney.net/wp-content/uploads/2018/05/Screen-Shot-2018-05-20-at-20.25.36-624x351.png" alt="insert process"></p>
<h3 id="a-hash-map-four-properties">a hash map four properties</h3>
<ol>
<li>You need a hash function for the key.</li>
<li>You need an equality function to compare keys.</li>
<li>You need to know the size of the key and,</li>
<li>You need to know the size of the value because these affect the size of the bucket structure, which the compiler needs to know, as you walk or insert into that structure, how far to advance in memory.</li>
</ol>
<h4 id="java">java</h4>
<p>boxing: boolean<code>, </code>int<code>, </code>short<code>, </code>long<code>, </code>byte<code>, </code>char<code>, </code>float<code>, and </code>double  to java.lang.Object</p>
<h4 id="c同java实现hashmap的优缺点">c++同java实现hashmap的优缺点</h4>
<h5 id="c">c++</h5>
<ul>
<li>key和value的大小，在compile阶段就知道</li>
<li>可以进行inlineing</li>
<li>速度快</li>
<li>编译和代码上慢，要有不同的types</li>
</ul>
<h5 id="java-1">java</h5>
<ul>
<li>天然有泛型的含义，一切都是object</li>
<li>同样也是缺点，boxing等方式，会增大gc的概率</li>
<li>Buckets are stored as linked lists, not sequential arrays</li>
</ul>
<h3 id="golang的实现">golang的实现</h3>
<p>While we have the <code>container/{list,heap}</code> packages which do use the empty interface, the runtime’s map implementation does not use <code>interface{}</code>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#E1E4E8">v </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> m[</span><span style="color:#9ECBFF">"key"</span><span style="color:#E1E4E8">]     → runtime.</span><span style="color:#B392F0">mapaccess1</span><span style="color:#E1E4E8">(m, ”key</span><span style="color:#9ECBFF">", &#x26;v)</span></span>
<span class="line"><span style="color:#9ECBFF">v, ok := m["</span><span style="color:#E1E4E8">key</span><span style="color:#9ECBFF">"] → runtime.mapaccess2(m, ”key”, &#x26;v, &#x26;ok)</span></span>
<span class="line"><span style="color:#9ECBFF">m["</span><span style="color:#E1E4E8">key</span><span style="color:#9ECBFF">"] = 9001   → runtime.mapinsert(m, ”key"</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">9001</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#B392F0">delete</span><span style="color:#E1E4E8">(m, </span><span style="color:#9ECBFF">"key"</span><span style="color:#E1E4E8">)  → runtime.</span><span style="color:#B392F0">mapdelete</span><span style="color:#E1E4E8">(m, “key”)</span></span>
<span class="line"></span></code></pre>
<p>实际上针对channel的操作？</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> mapaccess1</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">t</span><span style="color:#F97583"> *</span><span style="color:#B392F0">maptype</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">h</span><span style="color:#F97583"> *</span><span style="color:#B392F0">hmap</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">key</span><span style="color:#B392F0"> unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">) </span><span style="color:#B392F0">unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span></span>
<span class="line"></span></code></pre>
<p>在mapaccess中，指明maptype，不同于c++部分针对所有的map有不同的实现，golang部分，在compile阶段生成maptype字段</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> maptype</span><span style="color:#F97583"> struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        typ           </span><span style="color:#B392F0">_type</span></span>
<span class="line"><span style="color:#E1E4E8">        key         </span><span style="color:#F97583">*</span><span style="color:#B392F0">_type</span></span>
<span class="line"><span style="color:#E1E4E8">        elem        </span><span style="color:#F97583">*</span><span style="color:#B392F0">_type</span></span>
<span class="line"><span style="color:#E1E4E8">        bucket        </span><span style="color:#F97583">*</span><span style="color:#B392F0">_type</span><span style="color:#6A737D"> // internal type representing a hash bucket </span></span>
<span class="line"><span style="color:#E1E4E8">        hmap          </span><span style="color:#F97583">*</span><span style="color:#B392F0">_type</span><span style="color:#6A737D"> // internal type representing a hmap</span></span>
<span class="line"><span style="color:#E1E4E8">        keysize       </span><span style="color:#F97583">uint8</span><span style="color:#6A737D">  // size of key slot</span></span>
<span class="line"><span style="color:#E1E4E8">        indirectkey   </span><span style="color:#F97583">bool</span><span style="color:#6A737D">   // store ptr to key instead of key itself</span></span>
<span class="line"><span style="color:#E1E4E8">        valuesize     </span><span style="color:#F97583">uint8</span><span style="color:#6A737D">  // size of value slot</span></span>
<span class="line"><span style="color:#E1E4E8">        indirectvalue </span><span style="color:#F97583">bool</span><span style="color:#6A737D">   // store ptr to value instead of value itself</span></span>
<span class="line"><span style="color:#E1E4E8">        bucketsize    </span><span style="color:#F97583">uint16</span><span style="color:#6A737D"> // size of bucket</span></span>
<span class="line"><span style="color:#E1E4E8">        reflexivekey  </span><span style="color:#F97583">bool</span><span style="color:#6A737D">   // true if k==k for all keys</span></span>
<span class="line"><span style="color:#E1E4E8">        needkeyupdate </span><span style="color:#F97583">bool</span><span style="color:#6A737D">   // true if we need to update key on overwrite </span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>mapaccess的功能如下：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#6A737D">// mapaccess1 returns a pointer to h[key].  Never returns nil, instead </span></span>
<span class="line"><span style="color:#6A737D">// it will return a reference to the zero object for the value type if </span></span>
<span class="line"><span style="color:#6A737D">// the key is not in the map.</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> mapaccess1</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">t</span><span style="color:#F97583"> *</span><span style="color:#B392F0">maptype</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">h</span><span style="color:#F97583"> *</span><span style="color:#B392F0">hmap</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">key</span><span style="color:#B392F0"> unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">) </span><span style="color:#B392F0">unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8"> { </span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> h </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> nil</span><span style="color:#F97583"> ||</span><span style="color:#E1E4E8"> h.count </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">                return</span><span style="color:#E1E4E8"> unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">zeroVal[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">]) </span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">        alg </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> t.key.alg</span></span>
<span class="line"><span style="color:#E1E4E8">        hash </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> alg.</span><span style="color:#B392F0">hash</span><span style="color:#E1E4E8">(key, </span><span style="color:#F97583">uintptr</span><span style="color:#E1E4E8">(h.hash0))</span></span>
<span class="line"><span style="color:#E1E4E8">        m </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> bucketMask</span><span style="color:#E1E4E8">(h.B)</span></span>
<span class="line"><span style="color:#E1E4E8">        b </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">bmap</span><span style="color:#E1E4E8">)(</span><span style="color:#B392F0">add</span><span style="color:#E1E4E8">(h.buckets, (hash</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">m)</span><span style="color:#F97583">*uintptr</span><span style="color:#E1E4E8">(t.bucketsize)))</span></span>
<span class="line"></span></code></pre> </article>  </div>  </main> <footer class="animate" data-astro-cid-sz7xmlte> <div class="mx-auto max-w-screen-sm px-5">  <div class="flex justify-between items-center" data-astro-cid-sz7xmlte> <div data-astro-cid-sz7xmlte>
&copy; 2026 | Blog
</div> <div class="flex flex-wrap gap-1 items-center" data-astro-cid-sz7xmlte> <button id="light-theme-button" aria-label="Light theme" class="group size-8 flex items-center justify-center rounded-full" data-astro-cid-sz7xmlte> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="group-hover:stroke-black group-hover:dark:stroke-white transition-colors duration-300 ease-in-out" data-astro-cid-sz7xmlte> <circle cx="12" cy="12" r="5" data-astro-cid-sz7xmlte></circle> <line x1="12" y1="1" x2="12" y2="3" data-astro-cid-sz7xmlte></line> <line x1="12" y1="21" x2="12" y2="23" data-astro-cid-sz7xmlte></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" data-astro-cid-sz7xmlte></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" data-astro-cid-sz7xmlte></line> <line x1="1" y1="12" x2="3" y2="12" data-astro-cid-sz7xmlte></line> <line x1="21" y1="12" x2="23" y2="12" data-astro-cid-sz7xmlte></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" data-astro-cid-sz7xmlte></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" data-astro-cid-sz7xmlte></line> </svg> </button> <button id="dark-theme-button" aria-label="Dark theme" class="group size-8 flex items-center justify-center rounded-full" data-astro-cid-sz7xmlte> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="group-hover:stroke-black group-hover:dark:stroke-white transition-colors duration-300 ease-in-out" data-astro-cid-sz7xmlte> <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" data-astro-cid-sz7xmlte></path> </svg> </button> <button id="system-theme-button" aria-label="System theme" class="group size-8 flex items-center justify-center rounded-full" data-astro-cid-sz7xmlte> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="group-hover:stroke-black group-hover:dark:stroke-white transition-colors duration-300 ease-in-out" data-astro-cid-sz7xmlte> <rect x="2" y="3" width="20" height="14" rx="2" ry="2" data-astro-cid-sz7xmlte></rect> <line x1="8" y1="21" x2="16" y2="21" data-astro-cid-sz7xmlte></line> <line x1="12" y1="17" x2="12" y2="21" data-astro-cid-sz7xmlte></line> </svg> </button> </div> </div>  </div> </footer>  <script>
  function setTheme(theme) {
    document.documentElement.classList.remove("light", "dark", "system");
    
    if (theme === "system") {
      document.documentElement.classList.add("system");
      const systemTheme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
      document.documentElement.classList.add(systemTheme);
    } else {
      document.documentElement.classList.add(theme);
    }
    
    localStorage.setItem("theme", theme);
  }

  document.getElementById("light-theme-button")?.addEventListener("click", () => setTheme("light"));
  document.getElementById("dark-theme-button")?.addEventListener("click", () => setTheme("dark"));
  document.getElementById("system-theme-button")?.addEventListener("click", () => setTheme("system"));

  const savedTheme = localStorage.getItem("theme") || "system";
  setTheme(savedTheme);
</script>  </body> </html>