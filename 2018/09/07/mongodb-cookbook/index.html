<!DOCTYPE html><html lang="zh-CN"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v4.16.19"><title>Blog</title><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono&display=swap" rel="stylesheet"><style>:root{--primary: #2563eb;--text-main: #1f2937;--text-muted: #6b7280;--bg-main: #ffffff;--bg-secondary: #f9fafb;--border: #e5e7eb;--max-width: 800px;--font-sans: "Inter", system-ui, -apple-system, sans-serif;--font-mono: "JetBrains Mono", monospace}*{margin:0;padding:0;box-sizing:border-box}body{font-family:var(--font-sans);color:var(--text-main);background-color:var(--bg-main);line-height:1.6;-webkit-font-smoothing:antialiased}.app-container{display:flex;flex-direction:column;min-height:100vh}.navbar{border-bottom:1px solid var(--border);position:sticky;top:0;background:#fffc;backdrop-filter:blur(8px);z-index:100}.nav-content{max-width:var(--max-width);margin:0 auto;padding:1rem;display:flex;justify-content:space-between;align-items:center}.logo{text-decoration:none;color:var(--text-main);font-weight:800;font-size:1.5rem}.nav-links{list-style:none;display:flex;gap:1.5rem}.nav-links a{text-decoration:none;color:var(--text-muted);font-size:.95rem;font-weight:500;transition:color .2s}.nav-links a:hover{color:var(--primary)}.main-content{flex:1;max-width:var(--max-width);margin:0 auto;width:100%;padding:3rem 1rem}.footer{border-top:1px solid var(--border);background:var(--bg-secondary);padding:2rem 1rem;margin-top:4rem}.footer-content{max-width:var(--max-width);margin:0 auto;text-align:center;color:var(--text-muted);font-size:.9rem}.post-content h1,.post-content h2,.post-content h3{margin-top:2.5rem;margin-bottom:1rem;line-height:1.3}.post-content p{margin-bottom:1.5rem}.post-content img{max-width:100%;height:auto;border-radius:8px;margin:2rem 0}.post-content pre{border-radius:8px;padding:1.25rem;margin-bottom:2rem;font-family:var(--font-mono);font-size:.9rem;overflow-x:auto}.post-content code:not(pre code){background:var(--bg-secondary);padding:.2rem .4rem;border-radius:4px;font-family:var(--font-mono);font-size:.9em}.post-content blockquote{border-left:4px solid var(--primary);padding-left:1.5rem;font-style:italic;color:var(--text-muted);margin:2rem 0}.post-content ul,.post-content ol{margin-bottom:1.5rem;padding-left:1.5rem}.post-content li{margin-bottom:.5rem}
.post-header[data-astro-cid-rl3favg5]{margin-bottom:4rem;text-align:center}.post-date[data-astro-cid-rl3favg5]{display:block;font-size:.875rem;text-transform:uppercase;letter-spacing:.05em;color:var(--text-muted);font-weight:600;margin-bottom:1rem}.post-title[data-astro-cid-rl3favg5]{font-size:3rem;font-weight:800;line-height:1.1;margin-bottom:1.5rem;letter-spacing:-.025em}.post-meta[data-astro-cid-rl3favg5]{display:flex;justify-content:center;gap:1.5rem;font-size:.95rem;color:var(--text-muted)}.tag[data-astro-cid-rl3favg5]{color:var(--primary);margin-right:.5rem}@media (max-width: 640px){.post-title[data-astro-cid-rl3favg5]{font-size:2rem}}
</style></head> <body> <div class="app-container"> <header class="navbar"> <div class="nav-content"> <a href="/" class="logo"> <span class="logo-text">Blog</span> </a> <nav> <ul class="nav-links"> <li><a href="/">Home</a></li> <li><a href="/archive">Archive</a></li> <li><a href="/about">About</a></li> </ul> </nav> </div> </header> <main class="main-content">  <article class="post" data-astro-cid-rl3favg5> <header class="post-header" data-astro-cid-rl3favg5> <time class="post-date" data-astro-cid-rl3favg5> September 7, 2018 </time> <h1 class="post-title" data-astro-cid-rl3favg5></h1> <div class="post-meta" data-astro-cid-rl3favg5>   </div> </header> <div class="post-content" data-astro-cid-rl3favg5> <p>title: Mongodb Cookbook
date: 2018-09-07 07:54:07
categories: mongodb</p>
<h2 id="tags-mongodb">tags: [mongodb]</h2>
<p><a href="https://vinta.ws/code/mongodb-cookbook-queries-and-aggregations.html?utm_campaign=CodeTengu&#x26;utm_medium=email&#x26;utm_source=CodeTengu_140">原文链接</a></p>
<p>###admin</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#E1E4E8">db.</span><span style="color:#B392F0">currentOp</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// show queries</span></span>
<span class="line"><span style="color:#E1E4E8">db.</span><span style="color:#B392F0">currentOp</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#9ECBFF">    "active"</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">    "secs_running"</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">"$gt"</span><span style="color:#E1E4E8"> : </span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">},</span></span>
<span class="line"><span style="color:#9ECBFF">    "ns"</span><span style="color:#E1E4E8">:</span><span style="color:#9ECBFF"> /</span><span style="color:#F97583">^</span><span style="color:#DBEDFF">swag</span><span style="color:#85E89D;font-weight:bold">\.</span><span style="color:#9ECBFF">/</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// queries not using any index</span></span>
<span class="line"><span style="color:#E1E4E8">db.</span><span style="color:#B392F0">adminCommand</span><span style="color:#E1E4E8">({ </span></span>
<span class="line"><span style="color:#9ECBFF">    "currentOp"</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">    "op"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"query"</span><span style="color:#E1E4E8">, </span></span>
<span class="line"><span style="color:#9ECBFF">    "planSummary"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"COLLSCAN"</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// operations with high numYields</span></span>
<span class="line"><span style="color:#E1E4E8">db.</span><span style="color:#B392F0">adminCommand</span><span style="color:#E1E4E8">({ </span></span>
<span class="line"><span style="color:#9ECBFF">    "currentOp"</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">, </span></span>
<span class="line"><span style="color:#9ECBFF">    "ns"</span><span style="color:#E1E4E8">:</span><span style="color:#9ECBFF"> /</span><span style="color:#F97583">^</span><span style="color:#DBEDFF">swag</span><span style="color:#85E89D;font-weight:bold">\.</span><span style="color:#9ECBFF">/</span><span style="color:#E1E4E8">, </span></span>
<span class="line"><span style="color:#9ECBFF">    "numYields"</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">"$gte"</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">100</span><span style="color:#E1E4E8">} </span></span>
<span class="line"><span style="color:#E1E4E8">}) </span></span>
<span class="line"></span></code></pre>
<p>上面可以做为某些调优手段</p>
<h3 id="find-documents-with-an-array-field">Find Documents With An Array Field</h3>
<ul>
<li><code>$in: [...]</code> means “intersection” or “any element in”</li>
<li><code>$all: [...]</code> means “subset” or “contain”</li>
<li><code>$elemMatch: {...}</code> means “any element match”</li>
<li><code>$not: {$elemMatch: {$nin: [...]}}</code> means “subset” or “in”</li>
</ul>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#E1E4E8">db.</span><span style="color:#B392F0">getCollection</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'message'</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">find</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">    unlocks: {</span></span>
<span class="line"><span style="color:#E1E4E8">        $elemMatch: {</span></span>
<span class="line"><span style="color:#E1E4E8">            _cls: </span><span style="color:#9ECBFF">'PointsUnlock'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">            user: </span><span style="color:#B392F0">ObjectId</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"57f662e727a79d07993faec5"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span>
<span class="line"></span></code></pre>
<h3 id="find-documents-with-computed-values-using-expr">Find Documents With Computed Values Using <code>$expr</code></h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#E1E4E8">db.</span><span style="color:#B392F0">getCollection</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'user'</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">find</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">    $expr: {</span></span>
<span class="line"><span style="color:#E1E4E8">        $eq: [{$size: </span><span style="color:#9ECBFF">'$follows'</span><span style="color:#E1E4E8">}, {$size: </span><span style="color:#9ECBFF">'$blocks'</span><span style="color:#E1E4E8">}]</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span>
<span class="line"></span></code></pre>
<h3 id="for-loop">for loop</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#F97583">var</span><span style="color:#E1E4E8"> oldTags </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span><span style="color:#9ECBFF">'famous'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'newstar'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'featured'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'western'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'recommended'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'popular'</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#E1E4E8">oldTags.</span><span style="color:#B392F0">forEach</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">function</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">tag</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">    db.</span><span style="color:#B392F0">getCollection</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'user'</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">updateMany</span><span style="color:#E1E4E8">({tags: tag}, {$addToSet: {tags: </span><span style="color:#9ECBFF">'badge:'</span><span style="color:#F97583"> +</span><span style="color:#E1E4E8"> tag}});</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span></code></pre>
<h2 id="python-interface">python interface</h2>
<h4 id="insert-an-element-into-an-array-at-certain-postion">insert an element into an array at certain postion</h4>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#E1E4E8">slot </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 2</span></span>
<span class="line"><span style="color:#E1E4E8">Post.objects.filter(</span><span style="color:#FFAB70">id</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">post_id, </span><span style="color:#FFAB70">media__id__ne</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">media_id).update_one(</span><span style="color:#FFAB70">__raw__</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#9ECBFF">    '$push'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        'media'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">            '$each'</span><span style="color:#E1E4E8">: [{</span><span style="color:#9ECBFF">'id'</span><span style="color:#E1E4E8">: bson.ObjectId(media_id)}],</span></span>
<span class="line"><span style="color:#9ECBFF">            '$position'</span><span style="color:#E1E4E8">: slot,</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span>
<span class="line"></span></code></pre>
<h3 id="remove-elements">remove elements</h3>
<p>采用pull的操作？</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> bson</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">user_id </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> '5a66d5c2af9c462c617ce552'</span></span>
<span class="line"><span style="color:#E1E4E8">tags </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span><span style="color:#9ECBFF">'valid_tag_1'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'future_tag'</span><span style="color:#E1E4E8">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">updated_result </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> User._get_collection().update_one(</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span><span style="color:#9ECBFF">'_id'</span><span style="color:#E1E4E8">: bson.ObjectId(user_id)},</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span><span style="color:#9ECBFF">'$pull'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'schedules'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'tag'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$in'</span><span style="color:#E1E4E8">: tags}}}},</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#79B8FF">print</span><span style="color:#E1E4E8">(updated_result.raw_result)</span></span>
<span class="line"><span style="color:#6A737D"># {'n': 1, 'nModified': 1, 'ok': 1.0, 'updatedExisting': True}</span></span>
<span class="line"></span></code></pre>
<h3 id="upsert">upsert</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#E1E4E8">tag_schedule </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> TagSchedule.objects \</span></span>
<span class="line"><span style="color:#E1E4E8">    .filter(</span><span style="color:#FFAB70">user</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">user_id, </span><span style="color:#FFAB70">tag</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">'vip'</span><span style="color:#E1E4E8">) \</span></span>
<span class="line"><span style="color:#E1E4E8">    .modify(</span></span>
<span class="line"><span style="color:#FFAB70">        started_at</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">started_at,</span></span>
<span class="line"><span style="color:#FFAB70">        ended_at</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">ended_at,</span></span>
<span class="line"><span style="color:#FFAB70">        upsert</span><span style="color:#F97583">=</span><span style="color:#79B8FF">True</span></span>
<span class="line"><span style="color:#E1E4E8">    )</span></span>
<span class="line"></span></code></pre>
<p>设置<code>upsert=True</code></p>
<h2 id="aggregation-pipeline">Aggregation Pipeline</h2>
<ul>
<li><code>$match</code>: Filters documents.</li>
<li><code>$project</code>: Modifies document fields.</li>
<li><code>$group</code>: Groups documents by fields.</li>
<li><code>$lookup</code>: Joins another collection.</li>
<li><code>$replaceRoot</code>: Promotes an embedded document field to the top level and replace all other fields.</li>
<li><code>$unwind</code>: Expanses an array field into multiple documents along with original documents.</li>
<li><code>$facet</code>: Processes multiple pipelines within one stage and output to different fields.</li>
</ul>
<h3 id="match-multiple-condition">match multiple condition</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> werkzeug</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">user_agent </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> werkzeug.UserAgent(</span><span style="color:#9ECBFF">'swag/2.25.1 (iPhone; iOS 11.4.1; Scale/2.00; com.live.swag.enterprise; zh-tw)'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">user_preferences </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span><span style="color:#9ECBFF">'gender:female'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'gender:male'</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#E1E4E8">user_tags </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span><span style="color:#9ECBFF">'beta'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'vip'</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#E1E4E8">user_platforms </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [user_agent.platform]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> stages</span><span style="color:#E1E4E8">():</span></span>
<span class="line"><span style="color:#E1E4E8">    now </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> utils.utcnow()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$match'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        '$and'</span><span style="color:#E1E4E8">: [</span></span>
<span class="line"><span style="color:#E1E4E8">            {</span><span style="color:#9ECBFF">'nbf'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$lte'</span><span style="color:#E1E4E8">: now}},</span></span>
<span class="line"><span style="color:#E1E4E8">            {</span><span style="color:#9ECBFF">'exp'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$gt'</span><span style="color:#E1E4E8">: now}},</span></span>
<span class="line"><span style="color:#E1E4E8">            {</span><span style="color:#9ECBFF">'requirements'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$elemMatch'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">                'preferences'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$not'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$elemMatch'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$nin'</span><span style="color:#E1E4E8">: user_preferences}}},</span></span>
<span class="line"><span style="color:#9ECBFF">                'tags'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$not'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$elemMatch'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$nin'</span><span style="color:#E1E4E8">: user_tags}}},</span></span>
<span class="line"><span style="color:#9ECBFF">                'platforms'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$not'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$elemMatch'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$nin'</span><span style="color:#E1E4E8">: user_platforms}}},</span></span>
<span class="line"><span style="color:#9ECBFF">                '$or'</span><span style="color:#E1E4E8">: [</span></span>
<span class="line"><span style="color:#E1E4E8">                    {</span><span style="color:#9ECBFF">'$and'</span><span style="color:#E1E4E8">: [</span></span>
<span class="line"><span style="color:#E1E4E8">                        {</span><span style="color:#9ECBFF">'version_major_min'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$lte'</span><span style="color:#E1E4E8">: user_agent.version.major}},</span></span>
<span class="line"><span style="color:#E1E4E8">                        {</span><span style="color:#9ECBFF">'version_minor_min'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$lte'</span><span style="color:#E1E4E8">: user_agent.version.minor}},</span></span>
<span class="line"><span style="color:#E1E4E8">                    ]},</span></span>
<span class="line"><span style="color:#E1E4E8">                    {</span><span style="color:#9ECBFF">'$and'</span><span style="color:#E1E4E8">: [</span></span>
<span class="line"><span style="color:#E1E4E8">                        {</span><span style="color:#9ECBFF">'version_minor_min'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$exists'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">False</span><span style="color:#E1E4E8">}},</span></span>
<span class="line"><span style="color:#E1E4E8">                        {</span><span style="color:#9ECBFF">'version_minor_min'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$exists'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">False</span><span style="color:#E1E4E8">}},</span></span>
<span class="line"><span style="color:#E1E4E8">                    ]},</span></span>
<span class="line"><span style="color:#E1E4E8">                ],</span></span>
<span class="line"><span style="color:#E1E4E8">            }}},</span></span>
<span class="line"><span style="color:#E1E4E8">        ],</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$project'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        'name'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'nbf'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'exp'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'positions'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$objectToArray'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$positions'</span><span style="color:#E1E4E8">},</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$unwind'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$positions'</span><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$sort'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        'exp'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$project'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        '_id'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">False</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'name'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'position'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$positions.k'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'url'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$arrayElemAt'</span><span style="color:#E1E4E8">: [</span><span style="color:#9ECBFF">'$positions.v.urls'</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">]},</span></span>
<span class="line"><span style="color:#9ECBFF">        'startedAt'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$floor'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$divide'</span><span style="color:#E1E4E8">: [{</span><span style="color:#9ECBFF">'$subtract'</span><span style="color:#E1E4E8">: [</span><span style="color:#9ECBFF">'$nbf'</span><span style="color:#E1E4E8">, constants.</span><span style="color:#79B8FF">UNIX_EPOCH</span><span style="color:#E1E4E8">]}, </span><span style="color:#79B8FF">1000</span><span style="color:#E1E4E8">]}},</span></span>
<span class="line"><span style="color:#9ECBFF">        'endedAt'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$floor'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$divide'</span><span style="color:#E1E4E8">: [{</span><span style="color:#9ECBFF">'$subtract'</span><span style="color:#E1E4E8">: [</span><span style="color:#9ECBFF">'$exp'</span><span style="color:#E1E4E8">, constants.</span><span style="color:#79B8FF">UNIX_EPOCH</span><span style="color:#E1E4E8">]}, </span><span style="color:#79B8FF">1000</span><span style="color:#E1E4E8">]}},</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$group'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        '_id'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$position'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'items'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$push'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$$ROOT'</span><span style="color:#E1E4E8">},</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    docs </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Promotion.objects.aggregate(</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">stages())</span></span>
<span class="line"><span style="color:#F97583">except</span><span style="color:#79B8FF"> StopIteration</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    docs </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> []</span></span>
<span class="line"><span style="color:#F97583">else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    docs </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> list</span><span style="color:#E1E4E8">(docs)</span></span>
<span class="line"></span></code></pre>
<p>project负责显示项，unwind负责展开？</p>
<h3 id="collect-items-with-group-and-addtoset">Collect Items With <code>$group</code> And <code>$addToSet</code></h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> stages</span><span style="color:#E1E4E8">():</span></span>
<span class="line"><span style="color:#E1E4E8">    now </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> utils.utcnow()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$match'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        'schedules'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$elemMatch'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">            'nbf'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$lte'</span><span style="color:#E1E4E8">: now},</span></span>
<span class="line"><span style="color:#9ECBFF">            'exp'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$gte'</span><span style="color:#E1E4E8">: now}</span></span>
<span class="line"><span style="color:#E1E4E8">        }}</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$unwind'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$schedules'</span><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$match'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        'schedules.nbf'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$lte'</span><span style="color:#E1E4E8">: now},</span></span>
<span class="line"><span style="color:#9ECBFF">        'schedules.exp'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$gte'</span><span style="color:#E1E4E8">: now}</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$project'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        '_id'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">False</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'id'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$_id'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'username'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'tag'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$schedules.tag'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'nbf'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$schedules.nbf'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'exp'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$schedules.exp'</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$group'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        '_id'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$id'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'tags'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$addToSet'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$tag'</span><span style="color:#E1E4E8">},</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">for</span><span style="color:#E1E4E8"> user_tag_schedule </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> User.objects.aggregate(</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">stages()):</span></span>
<span class="line"><span style="color:#79B8FF">    print</span><span style="color:#E1E4E8">(user_tag_schedule)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># output:</span></span>
<span class="line"><span style="color:#6A737D"># {'_id': ObjectId('579b9387b7af8e1fd1635da9'), 'tags': ['stats']}</span></span>
<span class="line"><span style="color:#6A737D"># {'_id': ObjectId('5a66d5c2af9c462c617ce552'), 'tags': ['chat', 'vip']}</span></span>
<span class="line"></span></code></pre>
<h3 id="do-advanced-project-with-let">Do Advanced <code>$project</code> With <code>$let</code></h3>
<p>If you find youself want to do <code>$project</code> twice to tackle some fields, you should use <code>$let</code>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> stages</span><span style="color:#E1E4E8">():</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$match'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        'purchases.user'</span><span style="color:#E1E4E8">: g.user.id,</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$project'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        '_id'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">False</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'id'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$_id'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'name'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'image'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">            '$ifNull'</span><span style="color:#E1E4E8">: [{</span><span style="color:#9ECBFF">'$arrayElemAt'</span><span style="color:#E1E4E8">: [</span><span style="color:#9ECBFF">'$images'</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">]}, </span><span style="color:#79B8FF">None</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#E1E4E8">        },</span></span>
<span class="line"><span style="color:#9ECBFF">        'purchasedAt'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">            '$let'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">                'vars'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">                    'purchase'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">                        '$arrayElemAt'</span><span style="color:#E1E4E8">: [</span></span>
<span class="line"><span style="color:#E1E4E8">                            {</span></span>
<span class="line"><span style="color:#9ECBFF">                                '$filter'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">                                    'input'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$purchases'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">                                    'as'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'purchase'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">                                    'cond'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">                                        '$and'</span><span style="color:#E1E4E8">: [</span></span>
<span class="line"><span style="color:#E1E4E8">                                            {</span><span style="color:#9ECBFF">'$eq'</span><span style="color:#E1E4E8">: [</span><span style="color:#9ECBFF">'$$purchase.user'</span><span style="color:#E1E4E8">, g.user.id]},</span></span>
<span class="line"><span style="color:#E1E4E8">                                        ],</span></span>
<span class="line"><span style="color:#E1E4E8">                                    },</span></span>
<span class="line"><span style="color:#E1E4E8">                                },</span></span>
<span class="line"><span style="color:#E1E4E8">                            },</span></span>
<span class="line"><span style="color:#79B8FF">                            0</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">                        ],</span></span>
<span class="line"><span style="color:#E1E4E8">                    },</span></span>
<span class="line"><span style="color:#E1E4E8">                },</span></span>
<span class="line"><span style="color:#9ECBFF">                'in'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$$purchase.timestamp'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">            },</span></span>
<span class="line"><span style="color:#E1E4E8">        },</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    docs </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> MessagePackProduct.objects.aggregate(</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">stages())</span></span>
<span class="line"><span style="color:#F97583">except</span><span style="color:#79B8FF"> StopIteration</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    docs </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> []</span></span>
<span class="line"><span style="color:#F97583">else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> doc </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> docs:</span></span>
<span class="line"><span style="color:#79B8FF">        print</span><span style="color:#E1E4E8">(doc)</span></span>
<span class="line"></span></code></pre>
<h3 id="query-the-first-element-in-an-array-field-with-arrayelemat-and-filter">Query The First Element In An Array Field With <code>$arrayElemAt</code> And <code>$filter</code></h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> stages</span><span style="color:#E1E4E8">():</span></span>
<span class="line"><span style="color:#E1E4E8">    category_tag </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> 'category:user'</span></span>
<span class="line"><span style="color:#E1E4E8">    currency </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> 'usd'</span></span>
<span class="line"><span style="color:#E1E4E8">    platform </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> 'ios'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$match'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        'active'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'tags'</span><span style="color:#E1E4E8">: category_tag,</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$project'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        '_id'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">False</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'id'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$_id'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'name'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'caption'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'description'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'image'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">            '$ifNull'</span><span style="color:#E1E4E8">: [{</span><span style="color:#9ECBFF">'$arrayElemAt'</span><span style="color:#E1E4E8">: [</span><span style="color:#9ECBFF">'$images'</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">]}, </span><span style="color:#79B8FF">None</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#E1E4E8">        },</span></span>
<span class="line"><span style="color:#9ECBFF">        'preview_message'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'metadata'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'created_at'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'updated_at'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'active'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'sku'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">            '$ifNull'</span><span style="color:#E1E4E8">: [</span></span>
<span class="line"><span style="color:#E1E4E8">                {</span></span>
<span class="line"><span style="color:#9ECBFF">                    '$arrayElemAt'</span><span style="color:#E1E4E8">: [</span></span>
<span class="line"><span style="color:#E1E4E8">                        {</span></span>
<span class="line"><span style="color:#9ECBFF">                            '$filter'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">                                'input'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$skus'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">                                'as'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'sku'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">                                'cond'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">                                    '$and'</span><span style="color:#E1E4E8">: [</span></span>
<span class="line"><span style="color:#E1E4E8">                                        {</span><span style="color:#9ECBFF">'$eq'</span><span style="color:#E1E4E8">: [</span><span style="color:#9ECBFF">'$$sku.currency'</span><span style="color:#E1E4E8">, currency]},</span></span>
<span class="line"><span style="color:#E1E4E8">                                        {</span><span style="color:#9ECBFF">'$eq'</span><span style="color:#E1E4E8">: [</span><span style="color:#9ECBFF">'$$sku.attributes.platform'</span><span style="color:#E1E4E8">, platform]},</span></span>
<span class="line"><span style="color:#E1E4E8">                                    ]</span></span>
<span class="line"><span style="color:#E1E4E8">                                }</span></span>
<span class="line"><span style="color:#E1E4E8">                            },</span></span>
<span class="line"><span style="color:#E1E4E8">                        },</span></span>
<span class="line"><span style="color:#79B8FF">                        0</span></span>
<span class="line"><span style="color:#E1E4E8">                    ]</span></span>
<span class="line"><span style="color:#E1E4E8">                },</span></span>
<span class="line"><span style="color:#79B8FF">                None</span></span>
<span class="line"><span style="color:#E1E4E8">            ],</span></span>
<span class="line"><span style="color:#E1E4E8">        },</span></span>
<span class="line"><span style="color:#9ECBFF">        'tags'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'total'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'is_bought'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$in'</span><span style="color:#E1E4E8">: [g.user.id, {</span><span style="color:#9ECBFF">'$ifNull'</span><span style="color:#E1E4E8">: [</span><span style="color:#9ECBFF">'$purchases.user'</span><span style="color:#E1E4E8">, []]}]},</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$sort'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'is_bought'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'created_at'</span><span style="color:#E1E4E8">: </span><span style="color:#F97583">-</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">}}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    docs </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> MessagePackProduct.objects.aggregate(</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">stages())</span></span>
<span class="line"><span style="color:#F97583">except</span><span style="color:#79B8FF"> StopIteration</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    docs </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> []</span></span>
<span class="line"><span style="color:#F97583">else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> doc </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> docs:</span></span>
<span class="line"><span style="color:#79B8FF">        print</span><span style="color:#E1E4E8">(doc)</span></span>
<span class="line"></span></code></pre>
<h3 id="join-another-collection-using-lookup">Join Another Collection Using <code>$lookup</code></h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> stages</span><span style="color:#E1E4E8">():</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$match'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        'tags'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'pack:prod_CR1u34BIpDbHeo'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$lookup'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        'from'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'user'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'localField'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'sender'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'foreignField'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'_id'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'as'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'sender_data'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$unwind'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$sender_data'</span><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$project'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        '_id'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">False</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'id'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$_id'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'sender'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">            'id'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$sender_data._id'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">            'username'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$sender_data.username'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        },</span></span>
<span class="line"><span style="color:#9ECBFF">        'caption'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'posted_at'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$sort'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'posted_at'</span><span style="color:#E1E4E8">: </span><span style="color:#F97583">-</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">}}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    docs </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Message.objects.aggregate(</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">stages())</span></span>
<span class="line"><span style="color:#F97583">except</span><span style="color:#79B8FF"> StopIteration</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    docs </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> []</span></span>
<span class="line"><span style="color:#F97583">else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> doc </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> docs:</span></span>
<span class="line"><span style="color:#79B8FF">        print</span><span style="color:#E1E4E8">(doc)</span></span>
<span class="line"></span></code></pre>
<p>lookup作为join操作</p>
<h3 id="count-documents-in-another-collection-with-lookup-join">Count Documents In Another Collection With <code>$lookup</code> (JOIN)</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> stages</span><span style="color:#E1E4E8">():</span></span>
<span class="line"><span style="color:#E1E4E8">    category_tag </span><span style="color:#F97583">=</span><span style="color:#F97583"> f</span><span style="color:#9ECBFF">'category:</span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">category</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">'</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$match'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        'active'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'tags'</span><span style="color:#E1E4E8">: category_tag,</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$addFields'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        'message_pack_id_tag'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$concat'</span><span style="color:#E1E4E8">: [</span><span style="color:#9ECBFF">'pack:'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'$_id'</span><span style="color:#E1E4E8">]},</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$lookup'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        'from'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'message'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'localField'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'message_pack_id_tag'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'foreignField'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'tags'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'as'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'total'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$addFields'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        'total'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$size'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$total'</span><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$project'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        '_id'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">False</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'id'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$_id'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'name'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'total'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    docs </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> MessagePackProduct.objects.aggregate(</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">stages())</span></span>
<span class="line"><span style="color:#F97583">except</span><span style="color:#79B8FF"> StopIteration</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    docs </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> []</span></span>
<span class="line"><span style="color:#F97583">else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> doc </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> docs:</span></span>
<span class="line"><span style="color:#79B8FF">        print</span><span style="color:#E1E4E8">(doc)</span></span>
<span class="line"></span></code></pre>
<h2 id="useful-tools">useful tools</h2>
<h4 id="monitoring">monitoring</h4>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="shell"><code><span class="line"><span style="color:#B392F0">$</span><span style="color:#9ECBFF"> mongotop</span></span>
<span class="line"><span style="color:#B392F0">$</span><span style="color:#9ECBFF"> mongostat</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">$</span><span style="color:#9ECBFF"> pip</span><span style="color:#9ECBFF"> install</span><span style="color:#9ECBFF"> mongotail</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">$</span><span style="color:#9ECBFF"> mongotail</span><span style="color:#9ECBFF"> 127.0.0.1:27017/swag</span><span style="color:#79B8FF"> -l</span><span style="color:#79B8FF"> 2</span></span>
<span class="line"><span style="color:#B392F0">$</span><span style="color:#9ECBFF"> mongotail</span><span style="color:#9ECBFF"> 127.0.0.1:27017/swag</span><span style="color:#79B8FF"> -f</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">$</span><span style="color:#9ECBFF"> pip</span><span style="color:#9ECBFF"> install</span><span style="color:#9ECBFF"> mtools</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">$</span><span style="color:#9ECBFF"> mloginfo</span><span style="color:#9ECBFF"> mongod.log</span></span>
<span class="line"></span></code></pre> </div> </article>  </main> <footer class="footer"> <div class="footer-content"> <p>&copy; 2026 Liu Weifeng. Built with Astro.</p> </div> </footer> </div> </body></html> 