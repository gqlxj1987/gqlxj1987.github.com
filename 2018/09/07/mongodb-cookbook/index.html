<!DOCTYPE html><html lang="zh-CN"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v4.16.19"><meta name="description" content="Blog post"><title>Untitled</title><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet"><link rel="stylesheet" href="/_astro/_title_.8kzbYMPX.css"><script type="module">const e=()=>{document.querySelectorAll(".animate").forEach((t,s)=>{setTimeout(()=>{t.classList.add("show")},s*150)})};e();document.addEventListener("astro:after-swap",e);
</script></head> <body> <header> <div class="mx-auto max-w-screen-sm px-5">  <div class="flex flex-wrap gap-y-2 justify-between"> <a href="/" class="font-semibold hover:underline underline-offset-2">
Blog
</a> <nav class="flex gap-1">  <a href="/archive" class="hover:underline underline-offset-2"> Archive </a> <span>/</span> <a href="/about" class="hover:underline underline-offset-2"> About </a>  </nav> </div>  </div> </header> <main>  <div class="mx-auto max-w-screen-sm px-5">  <div class="animate"> <a href="/archive" class="hover:underline underline-offset-2">
← Back to archive
</a> </div> <div class="space-y-1 my-10"> <div class="animate flex items-center gap-1.5"> <div class="font-base text-sm"> <time datetime="2018-09-07T00:00:00.000Z"> September 7, 2018 </time> </div> </div> <div class="animate text-2xl font-semibold text-black dark:text-white">  </div>  </div> <article class="animate"> <p>title: Mongodb Cookbook
date: 2018-09-07 07:54:07
categories: mongodb</p>
<h2 id="tags-mongodb">tags: [mongodb]</h2>
<p><a href="https://vinta.ws/code/mongodb-cookbook-queries-and-aggregations.html?utm_campaign=CodeTengu&#x26;utm_medium=email&#x26;utm_source=CodeTengu_140">原文链接</a></p>
<p>###admin</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#E1E4E8">db.</span><span style="color:#B392F0">currentOp</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// show queries</span></span>
<span class="line"><span style="color:#E1E4E8">db.</span><span style="color:#B392F0">currentOp</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#9ECBFF">    "active"</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">    "secs_running"</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">"$gt"</span><span style="color:#E1E4E8"> : </span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">},</span></span>
<span class="line"><span style="color:#9ECBFF">    "ns"</span><span style="color:#E1E4E8">:</span><span style="color:#9ECBFF"> /</span><span style="color:#F97583">^</span><span style="color:#DBEDFF">swag</span><span style="color:#85E89D;font-weight:bold">\.</span><span style="color:#9ECBFF">/</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// queries not using any index</span></span>
<span class="line"><span style="color:#E1E4E8">db.</span><span style="color:#B392F0">adminCommand</span><span style="color:#E1E4E8">({ </span></span>
<span class="line"><span style="color:#9ECBFF">    "currentOp"</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">    "op"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"query"</span><span style="color:#E1E4E8">, </span></span>
<span class="line"><span style="color:#9ECBFF">    "planSummary"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"COLLSCAN"</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// operations with high numYields</span></span>
<span class="line"><span style="color:#E1E4E8">db.</span><span style="color:#B392F0">adminCommand</span><span style="color:#E1E4E8">({ </span></span>
<span class="line"><span style="color:#9ECBFF">    "currentOp"</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">, </span></span>
<span class="line"><span style="color:#9ECBFF">    "ns"</span><span style="color:#E1E4E8">:</span><span style="color:#9ECBFF"> /</span><span style="color:#F97583">^</span><span style="color:#DBEDFF">swag</span><span style="color:#85E89D;font-weight:bold">\.</span><span style="color:#9ECBFF">/</span><span style="color:#E1E4E8">, </span></span>
<span class="line"><span style="color:#9ECBFF">    "numYields"</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">"$gte"</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">100</span><span style="color:#E1E4E8">} </span></span>
<span class="line"><span style="color:#E1E4E8">}) </span></span>
<span class="line"></span></code></pre>
<p>上面可以做为某些调优手段</p>
<h3 id="find-documents-with-an-array-field">Find Documents With An Array Field</h3>
<ul>
<li><code>$in: [...]</code> means “intersection” or “any element in”</li>
<li><code>$all: [...]</code> means “subset” or “contain”</li>
<li><code>$elemMatch: {...}</code> means “any element match”</li>
<li><code>$not: {$elemMatch: {$nin: [...]}}</code> means “subset” or “in”</li>
</ul>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#E1E4E8">db.</span><span style="color:#B392F0">getCollection</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'message'</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">find</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">    unlocks: {</span></span>
<span class="line"><span style="color:#E1E4E8">        $elemMatch: {</span></span>
<span class="line"><span style="color:#E1E4E8">            _cls: </span><span style="color:#9ECBFF">'PointsUnlock'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">            user: </span><span style="color:#B392F0">ObjectId</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"57f662e727a79d07993faec5"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span>
<span class="line"></span></code></pre>
<h3 id="find-documents-with-computed-values-using-expr">Find Documents With Computed Values Using <code>$expr</code></h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#E1E4E8">db.</span><span style="color:#B392F0">getCollection</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'user'</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">find</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">    $expr: {</span></span>
<span class="line"><span style="color:#E1E4E8">        $eq: [{$size: </span><span style="color:#9ECBFF">'$follows'</span><span style="color:#E1E4E8">}, {$size: </span><span style="color:#9ECBFF">'$blocks'</span><span style="color:#E1E4E8">}]</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span>
<span class="line"></span></code></pre>
<h3 id="for-loop">for loop</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#F97583">var</span><span style="color:#E1E4E8"> oldTags </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span><span style="color:#9ECBFF">'famous'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'newstar'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'featured'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'western'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'recommended'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'popular'</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#E1E4E8">oldTags.</span><span style="color:#B392F0">forEach</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">function</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">tag</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">    db.</span><span style="color:#B392F0">getCollection</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'user'</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">updateMany</span><span style="color:#E1E4E8">({tags: tag}, {$addToSet: {tags: </span><span style="color:#9ECBFF">'badge:'</span><span style="color:#F97583"> +</span><span style="color:#E1E4E8"> tag}});</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span></code></pre>
<h2 id="python-interface">python interface</h2>
<h4 id="insert-an-element-into-an-array-at-certain-postion">insert an element into an array at certain postion</h4>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#E1E4E8">slot </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 2</span></span>
<span class="line"><span style="color:#E1E4E8">Post.objects.filter(</span><span style="color:#FFAB70">id</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">post_id, </span><span style="color:#FFAB70">media__id__ne</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">media_id).update_one(</span><span style="color:#FFAB70">__raw__</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#9ECBFF">    '$push'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        'media'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">            '$each'</span><span style="color:#E1E4E8">: [{</span><span style="color:#9ECBFF">'id'</span><span style="color:#E1E4E8">: bson.ObjectId(media_id)}],</span></span>
<span class="line"><span style="color:#9ECBFF">            '$position'</span><span style="color:#E1E4E8">: slot,</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span>
<span class="line"></span></code></pre>
<h3 id="remove-elements">remove elements</h3>
<p>采用pull的操作？</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> bson</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">user_id </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> '5a66d5c2af9c462c617ce552'</span></span>
<span class="line"><span style="color:#E1E4E8">tags </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span><span style="color:#9ECBFF">'valid_tag_1'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'future_tag'</span><span style="color:#E1E4E8">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">updated_result </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> User._get_collection().update_one(</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span><span style="color:#9ECBFF">'_id'</span><span style="color:#E1E4E8">: bson.ObjectId(user_id)},</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span><span style="color:#9ECBFF">'$pull'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'schedules'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'tag'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$in'</span><span style="color:#E1E4E8">: tags}}}},</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#79B8FF">print</span><span style="color:#E1E4E8">(updated_result.raw_result)</span></span>
<span class="line"><span style="color:#6A737D"># {'n': 1, 'nModified': 1, 'ok': 1.0, 'updatedExisting': True}</span></span>
<span class="line"></span></code></pre>
<h3 id="upsert">upsert</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#E1E4E8">tag_schedule </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> TagSchedule.objects \</span></span>
<span class="line"><span style="color:#E1E4E8">    .filter(</span><span style="color:#FFAB70">user</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">user_id, </span><span style="color:#FFAB70">tag</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">'vip'</span><span style="color:#E1E4E8">) \</span></span>
<span class="line"><span style="color:#E1E4E8">    .modify(</span></span>
<span class="line"><span style="color:#FFAB70">        started_at</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">started_at,</span></span>
<span class="line"><span style="color:#FFAB70">        ended_at</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">ended_at,</span></span>
<span class="line"><span style="color:#FFAB70">        upsert</span><span style="color:#F97583">=</span><span style="color:#79B8FF">True</span></span>
<span class="line"><span style="color:#E1E4E8">    )</span></span>
<span class="line"></span></code></pre>
<p>设置<code>upsert=True</code></p>
<h2 id="aggregation-pipeline">Aggregation Pipeline</h2>
<ul>
<li><code>$match</code>: Filters documents.</li>
<li><code>$project</code>: Modifies document fields.</li>
<li><code>$group</code>: Groups documents by fields.</li>
<li><code>$lookup</code>: Joins another collection.</li>
<li><code>$replaceRoot</code>: Promotes an embedded document field to the top level and replace all other fields.</li>
<li><code>$unwind</code>: Expanses an array field into multiple documents along with original documents.</li>
<li><code>$facet</code>: Processes multiple pipelines within one stage and output to different fields.</li>
</ul>
<h3 id="match-multiple-condition">match multiple condition</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> werkzeug</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">user_agent </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> werkzeug.UserAgent(</span><span style="color:#9ECBFF">'swag/2.25.1 (iPhone; iOS 11.4.1; Scale/2.00; com.live.swag.enterprise; zh-tw)'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">user_preferences </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span><span style="color:#9ECBFF">'gender:female'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'gender:male'</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#E1E4E8">user_tags </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span><span style="color:#9ECBFF">'beta'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'vip'</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#E1E4E8">user_platforms </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [user_agent.platform]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> stages</span><span style="color:#E1E4E8">():</span></span>
<span class="line"><span style="color:#E1E4E8">    now </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> utils.utcnow()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$match'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        '$and'</span><span style="color:#E1E4E8">: [</span></span>
<span class="line"><span style="color:#E1E4E8">            {</span><span style="color:#9ECBFF">'nbf'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$lte'</span><span style="color:#E1E4E8">: now}},</span></span>
<span class="line"><span style="color:#E1E4E8">            {</span><span style="color:#9ECBFF">'exp'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$gt'</span><span style="color:#E1E4E8">: now}},</span></span>
<span class="line"><span style="color:#E1E4E8">            {</span><span style="color:#9ECBFF">'requirements'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$elemMatch'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">                'preferences'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$not'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$elemMatch'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$nin'</span><span style="color:#E1E4E8">: user_preferences}}},</span></span>
<span class="line"><span style="color:#9ECBFF">                'tags'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$not'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$elemMatch'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$nin'</span><span style="color:#E1E4E8">: user_tags}}},</span></span>
<span class="line"><span style="color:#9ECBFF">                'platforms'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$not'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$elemMatch'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$nin'</span><span style="color:#E1E4E8">: user_platforms}}},</span></span>
<span class="line"><span style="color:#9ECBFF">                '$or'</span><span style="color:#E1E4E8">: [</span></span>
<span class="line"><span style="color:#E1E4E8">                    {</span><span style="color:#9ECBFF">'$and'</span><span style="color:#E1E4E8">: [</span></span>
<span class="line"><span style="color:#E1E4E8">                        {</span><span style="color:#9ECBFF">'version_major_min'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$lte'</span><span style="color:#E1E4E8">: user_agent.version.major}},</span></span>
<span class="line"><span style="color:#E1E4E8">                        {</span><span style="color:#9ECBFF">'version_minor_min'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$lte'</span><span style="color:#E1E4E8">: user_agent.version.minor}},</span></span>
<span class="line"><span style="color:#E1E4E8">                    ]},</span></span>
<span class="line"><span style="color:#E1E4E8">                    {</span><span style="color:#9ECBFF">'$and'</span><span style="color:#E1E4E8">: [</span></span>
<span class="line"><span style="color:#E1E4E8">                        {</span><span style="color:#9ECBFF">'version_minor_min'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$exists'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">False</span><span style="color:#E1E4E8">}},</span></span>
<span class="line"><span style="color:#E1E4E8">                        {</span><span style="color:#9ECBFF">'version_minor_min'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$exists'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">False</span><span style="color:#E1E4E8">}},</span></span>
<span class="line"><span style="color:#E1E4E8">                    ]},</span></span>
<span class="line"><span style="color:#E1E4E8">                ],</span></span>
<span class="line"><span style="color:#E1E4E8">            }}},</span></span>
<span class="line"><span style="color:#E1E4E8">        ],</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$project'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        'name'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'nbf'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'exp'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'positions'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$objectToArray'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$positions'</span><span style="color:#E1E4E8">},</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$unwind'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$positions'</span><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$sort'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        'exp'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$project'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        '_id'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">False</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'name'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'position'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$positions.k'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'url'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$arrayElemAt'</span><span style="color:#E1E4E8">: [</span><span style="color:#9ECBFF">'$positions.v.urls'</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">]},</span></span>
<span class="line"><span style="color:#9ECBFF">        'startedAt'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$floor'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$divide'</span><span style="color:#E1E4E8">: [{</span><span style="color:#9ECBFF">'$subtract'</span><span style="color:#E1E4E8">: [</span><span style="color:#9ECBFF">'$nbf'</span><span style="color:#E1E4E8">, constants.</span><span style="color:#79B8FF">UNIX_EPOCH</span><span style="color:#E1E4E8">]}, </span><span style="color:#79B8FF">1000</span><span style="color:#E1E4E8">]}},</span></span>
<span class="line"><span style="color:#9ECBFF">        'endedAt'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$floor'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$divide'</span><span style="color:#E1E4E8">: [{</span><span style="color:#9ECBFF">'$subtract'</span><span style="color:#E1E4E8">: [</span><span style="color:#9ECBFF">'$exp'</span><span style="color:#E1E4E8">, constants.</span><span style="color:#79B8FF">UNIX_EPOCH</span><span style="color:#E1E4E8">]}, </span><span style="color:#79B8FF">1000</span><span style="color:#E1E4E8">]}},</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$group'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        '_id'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$position'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'items'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$push'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$$ROOT'</span><span style="color:#E1E4E8">},</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    docs </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Promotion.objects.aggregate(</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">stages())</span></span>
<span class="line"><span style="color:#F97583">except</span><span style="color:#79B8FF"> StopIteration</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    docs </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> []</span></span>
<span class="line"><span style="color:#F97583">else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    docs </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> list</span><span style="color:#E1E4E8">(docs)</span></span>
<span class="line"></span></code></pre>
<p>project负责显示项，unwind负责展开？</p>
<h3 id="collect-items-with-group-and-addtoset">Collect Items With <code>$group</code> And <code>$addToSet</code></h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> stages</span><span style="color:#E1E4E8">():</span></span>
<span class="line"><span style="color:#E1E4E8">    now </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> utils.utcnow()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$match'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        'schedules'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$elemMatch'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">            'nbf'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$lte'</span><span style="color:#E1E4E8">: now},</span></span>
<span class="line"><span style="color:#9ECBFF">            'exp'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$gte'</span><span style="color:#E1E4E8">: now}</span></span>
<span class="line"><span style="color:#E1E4E8">        }}</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$unwind'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$schedules'</span><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$match'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        'schedules.nbf'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$lte'</span><span style="color:#E1E4E8">: now},</span></span>
<span class="line"><span style="color:#9ECBFF">        'schedules.exp'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$gte'</span><span style="color:#E1E4E8">: now}</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$project'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        '_id'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">False</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'id'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$_id'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'username'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'tag'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$schedules.tag'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'nbf'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$schedules.nbf'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'exp'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$schedules.exp'</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$group'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        '_id'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$id'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'tags'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$addToSet'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$tag'</span><span style="color:#E1E4E8">},</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">for</span><span style="color:#E1E4E8"> user_tag_schedule </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> User.objects.aggregate(</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">stages()):</span></span>
<span class="line"><span style="color:#79B8FF">    print</span><span style="color:#E1E4E8">(user_tag_schedule)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># output:</span></span>
<span class="line"><span style="color:#6A737D"># {'_id': ObjectId('579b9387b7af8e1fd1635da9'), 'tags': ['stats']}</span></span>
<span class="line"><span style="color:#6A737D"># {'_id': ObjectId('5a66d5c2af9c462c617ce552'), 'tags': ['chat', 'vip']}</span></span>
<span class="line"></span></code></pre>
<h3 id="do-advanced-project-with-let">Do Advanced <code>$project</code> With <code>$let</code></h3>
<p>If you find youself want to do <code>$project</code> twice to tackle some fields, you should use <code>$let</code>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> stages</span><span style="color:#E1E4E8">():</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$match'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        'purchases.user'</span><span style="color:#E1E4E8">: g.user.id,</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$project'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        '_id'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">False</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'id'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$_id'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'name'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'image'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">            '$ifNull'</span><span style="color:#E1E4E8">: [{</span><span style="color:#9ECBFF">'$arrayElemAt'</span><span style="color:#E1E4E8">: [</span><span style="color:#9ECBFF">'$images'</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">]}, </span><span style="color:#79B8FF">None</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#E1E4E8">        },</span></span>
<span class="line"><span style="color:#9ECBFF">        'purchasedAt'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">            '$let'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">                'vars'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">                    'purchase'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">                        '$arrayElemAt'</span><span style="color:#E1E4E8">: [</span></span>
<span class="line"><span style="color:#E1E4E8">                            {</span></span>
<span class="line"><span style="color:#9ECBFF">                                '$filter'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">                                    'input'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$purchases'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">                                    'as'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'purchase'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">                                    'cond'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">                                        '$and'</span><span style="color:#E1E4E8">: [</span></span>
<span class="line"><span style="color:#E1E4E8">                                            {</span><span style="color:#9ECBFF">'$eq'</span><span style="color:#E1E4E8">: [</span><span style="color:#9ECBFF">'$$purchase.user'</span><span style="color:#E1E4E8">, g.user.id]},</span></span>
<span class="line"><span style="color:#E1E4E8">                                        ],</span></span>
<span class="line"><span style="color:#E1E4E8">                                    },</span></span>
<span class="line"><span style="color:#E1E4E8">                                },</span></span>
<span class="line"><span style="color:#E1E4E8">                            },</span></span>
<span class="line"><span style="color:#79B8FF">                            0</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">                        ],</span></span>
<span class="line"><span style="color:#E1E4E8">                    },</span></span>
<span class="line"><span style="color:#E1E4E8">                },</span></span>
<span class="line"><span style="color:#9ECBFF">                'in'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$$purchase.timestamp'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">            },</span></span>
<span class="line"><span style="color:#E1E4E8">        },</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    docs </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> MessagePackProduct.objects.aggregate(</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">stages())</span></span>
<span class="line"><span style="color:#F97583">except</span><span style="color:#79B8FF"> StopIteration</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    docs </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> []</span></span>
<span class="line"><span style="color:#F97583">else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> doc </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> docs:</span></span>
<span class="line"><span style="color:#79B8FF">        print</span><span style="color:#E1E4E8">(doc)</span></span>
<span class="line"></span></code></pre>
<h3 id="query-the-first-element-in-an-array-field-with-arrayelemat-and-filter">Query The First Element In An Array Field With <code>$arrayElemAt</code> And <code>$filter</code></h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> stages</span><span style="color:#E1E4E8">():</span></span>
<span class="line"><span style="color:#E1E4E8">    category_tag </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> 'category:user'</span></span>
<span class="line"><span style="color:#E1E4E8">    currency </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> 'usd'</span></span>
<span class="line"><span style="color:#E1E4E8">    platform </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> 'ios'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$match'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        'active'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'tags'</span><span style="color:#E1E4E8">: category_tag,</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$project'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        '_id'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">False</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'id'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$_id'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'name'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'caption'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'description'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'image'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">            '$ifNull'</span><span style="color:#E1E4E8">: [{</span><span style="color:#9ECBFF">'$arrayElemAt'</span><span style="color:#E1E4E8">: [</span><span style="color:#9ECBFF">'$images'</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">]}, </span><span style="color:#79B8FF">None</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#E1E4E8">        },</span></span>
<span class="line"><span style="color:#9ECBFF">        'preview_message'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'metadata'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'created_at'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'updated_at'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'active'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'sku'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">            '$ifNull'</span><span style="color:#E1E4E8">: [</span></span>
<span class="line"><span style="color:#E1E4E8">                {</span></span>
<span class="line"><span style="color:#9ECBFF">                    '$arrayElemAt'</span><span style="color:#E1E4E8">: [</span></span>
<span class="line"><span style="color:#E1E4E8">                        {</span></span>
<span class="line"><span style="color:#9ECBFF">                            '$filter'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">                                'input'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$skus'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">                                'as'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'sku'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">                                'cond'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">                                    '$and'</span><span style="color:#E1E4E8">: [</span></span>
<span class="line"><span style="color:#E1E4E8">                                        {</span><span style="color:#9ECBFF">'$eq'</span><span style="color:#E1E4E8">: [</span><span style="color:#9ECBFF">'$$sku.currency'</span><span style="color:#E1E4E8">, currency]},</span></span>
<span class="line"><span style="color:#E1E4E8">                                        {</span><span style="color:#9ECBFF">'$eq'</span><span style="color:#E1E4E8">: [</span><span style="color:#9ECBFF">'$$sku.attributes.platform'</span><span style="color:#E1E4E8">, platform]},</span></span>
<span class="line"><span style="color:#E1E4E8">                                    ]</span></span>
<span class="line"><span style="color:#E1E4E8">                                }</span></span>
<span class="line"><span style="color:#E1E4E8">                            },</span></span>
<span class="line"><span style="color:#E1E4E8">                        },</span></span>
<span class="line"><span style="color:#79B8FF">                        0</span></span>
<span class="line"><span style="color:#E1E4E8">                    ]</span></span>
<span class="line"><span style="color:#E1E4E8">                },</span></span>
<span class="line"><span style="color:#79B8FF">                None</span></span>
<span class="line"><span style="color:#E1E4E8">            ],</span></span>
<span class="line"><span style="color:#E1E4E8">        },</span></span>
<span class="line"><span style="color:#9ECBFF">        'tags'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'total'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'is_bought'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$in'</span><span style="color:#E1E4E8">: [g.user.id, {</span><span style="color:#9ECBFF">'$ifNull'</span><span style="color:#E1E4E8">: [</span><span style="color:#9ECBFF">'$purchases.user'</span><span style="color:#E1E4E8">, []]}]},</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$sort'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'is_bought'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'created_at'</span><span style="color:#E1E4E8">: </span><span style="color:#F97583">-</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">}}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    docs </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> MessagePackProduct.objects.aggregate(</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">stages())</span></span>
<span class="line"><span style="color:#F97583">except</span><span style="color:#79B8FF"> StopIteration</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    docs </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> []</span></span>
<span class="line"><span style="color:#F97583">else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> doc </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> docs:</span></span>
<span class="line"><span style="color:#79B8FF">        print</span><span style="color:#E1E4E8">(doc)</span></span>
<span class="line"></span></code></pre>
<h3 id="join-another-collection-using-lookup">Join Another Collection Using <code>$lookup</code></h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> stages</span><span style="color:#E1E4E8">():</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$match'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        'tags'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'pack:prod_CR1u34BIpDbHeo'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$lookup'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        'from'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'user'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'localField'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'sender'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'foreignField'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'_id'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'as'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'sender_data'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$unwind'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$sender_data'</span><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$project'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        '_id'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">False</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'id'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$_id'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'sender'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">            'id'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$sender_data._id'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">            'username'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$sender_data.username'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        },</span></span>
<span class="line"><span style="color:#9ECBFF">        'caption'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'posted_at'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$sort'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'posted_at'</span><span style="color:#E1E4E8">: </span><span style="color:#F97583">-</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">}}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    docs </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Message.objects.aggregate(</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">stages())</span></span>
<span class="line"><span style="color:#F97583">except</span><span style="color:#79B8FF"> StopIteration</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    docs </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> []</span></span>
<span class="line"><span style="color:#F97583">else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> doc </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> docs:</span></span>
<span class="line"><span style="color:#79B8FF">        print</span><span style="color:#E1E4E8">(doc)</span></span>
<span class="line"></span></code></pre>
<p>lookup作为join操作</p>
<h3 id="count-documents-in-another-collection-with-lookup-join">Count Documents In Another Collection With <code>$lookup</code> (JOIN)</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> stages</span><span style="color:#E1E4E8">():</span></span>
<span class="line"><span style="color:#E1E4E8">    category_tag </span><span style="color:#F97583">=</span><span style="color:#F97583"> f</span><span style="color:#9ECBFF">'category:</span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">category</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">'</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$match'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        'active'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'tags'</span><span style="color:#E1E4E8">: category_tag,</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$addFields'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        'message_pack_id_tag'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$concat'</span><span style="color:#E1E4E8">: [</span><span style="color:#9ECBFF">'pack:'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'$_id'</span><span style="color:#E1E4E8">]},</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$lookup'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        'from'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'message'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'localField'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'message_pack_id_tag'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'foreignField'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'tags'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'as'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'total'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$addFields'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        'total'</span><span style="color:#E1E4E8">: {</span><span style="color:#9ECBFF">'$size'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$total'</span><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"><span style="color:#F97583">    yield</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">'$project'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">        '_id'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">False</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'id'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'$_id'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'name'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'total'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    }}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    docs </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> MessagePackProduct.objects.aggregate(</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">stages())</span></span>
<span class="line"><span style="color:#F97583">except</span><span style="color:#79B8FF"> StopIteration</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    docs </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> []</span></span>
<span class="line"><span style="color:#F97583">else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> doc </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> docs:</span></span>
<span class="line"><span style="color:#79B8FF">        print</span><span style="color:#E1E4E8">(doc)</span></span>
<span class="line"></span></code></pre>
<h2 id="useful-tools">useful tools</h2>
<h4 id="monitoring">monitoring</h4>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="shell"><code><span class="line"><span style="color:#B392F0">$</span><span style="color:#9ECBFF"> mongotop</span></span>
<span class="line"><span style="color:#B392F0">$</span><span style="color:#9ECBFF"> mongostat</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">$</span><span style="color:#9ECBFF"> pip</span><span style="color:#9ECBFF"> install</span><span style="color:#9ECBFF"> mongotail</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">$</span><span style="color:#9ECBFF"> mongotail</span><span style="color:#9ECBFF"> 127.0.0.1:27017/swag</span><span style="color:#79B8FF"> -l</span><span style="color:#79B8FF"> 2</span></span>
<span class="line"><span style="color:#B392F0">$</span><span style="color:#9ECBFF"> mongotail</span><span style="color:#9ECBFF"> 127.0.0.1:27017/swag</span><span style="color:#79B8FF"> -f</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">$</span><span style="color:#9ECBFF"> pip</span><span style="color:#9ECBFF"> install</span><span style="color:#9ECBFF"> mtools</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">$</span><span style="color:#9ECBFF"> mloginfo</span><span style="color:#9ECBFF"> mongod.log</span></span>
<span class="line"></span></code></pre> </article>  </div>  </main> <footer class="animate" data-astro-cid-sz7xmlte> <div class="mx-auto max-w-screen-sm px-5">  <div class="flex justify-between items-center" data-astro-cid-sz7xmlte> <div data-astro-cid-sz7xmlte>
&copy; 2026 | Blog
</div> <div class="flex flex-wrap gap-1 items-center" data-astro-cid-sz7xmlte> <button id="light-theme-button" aria-label="Light theme" class="group size-8 flex items-center justify-center rounded-full" data-astro-cid-sz7xmlte> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="group-hover:stroke-black group-hover:dark:stroke-white transition-colors duration-300 ease-in-out" data-astro-cid-sz7xmlte> <circle cx="12" cy="12" r="5" data-astro-cid-sz7xmlte></circle> <line x1="12" y1="1" x2="12" y2="3" data-astro-cid-sz7xmlte></line> <line x1="12" y1="21" x2="12" y2="23" data-astro-cid-sz7xmlte></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" data-astro-cid-sz7xmlte></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" data-astro-cid-sz7xmlte></line> <line x1="1" y1="12" x2="3" y2="12" data-astro-cid-sz7xmlte></line> <line x1="21" y1="12" x2="23" y2="12" data-astro-cid-sz7xmlte></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" data-astro-cid-sz7xmlte></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" data-astro-cid-sz7xmlte></line> </svg> </button> <button id="dark-theme-button" aria-label="Dark theme" class="group size-8 flex items-center justify-center rounded-full" data-astro-cid-sz7xmlte> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="group-hover:stroke-black group-hover:dark:stroke-white transition-colors duration-300 ease-in-out" data-astro-cid-sz7xmlte> <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" data-astro-cid-sz7xmlte></path> </svg> </button> <button id="system-theme-button" aria-label="System theme" class="group size-8 flex items-center justify-center rounded-full" data-astro-cid-sz7xmlte> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="group-hover:stroke-black group-hover:dark:stroke-white transition-colors duration-300 ease-in-out" data-astro-cid-sz7xmlte> <rect x="2" y="3" width="20" height="14" rx="2" ry="2" data-astro-cid-sz7xmlte></rect> <line x1="8" y1="21" x2="16" y2="21" data-astro-cid-sz7xmlte></line> <line x1="12" y1="17" x2="12" y2="21" data-astro-cid-sz7xmlte></line> </svg> </button> </div> </div>  </div> </footer>  <script>
  function setTheme(theme) {
    document.documentElement.classList.remove("light", "dark", "system");
    
    if (theme === "system") {
      document.documentElement.classList.add("system");
      const systemTheme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
      document.documentElement.classList.add(systemTheme);
    } else {
      document.documentElement.classList.add(theme);
    }
    
    localStorage.setItem("theme", theme);
  }

  document.getElementById("light-theme-button")?.addEventListener("click", () => setTheme("light"));
  document.getElementById("dark-theme-button")?.addEventListener("click", () => setTheme("dark"));
  document.getElementById("system-theme-button")?.addEventListener("click", () => setTheme("system"));

  const savedTheme = localStorage.getItem("theme") || "system";
  setTheme(savedTheme);
</script>  </body> </html>