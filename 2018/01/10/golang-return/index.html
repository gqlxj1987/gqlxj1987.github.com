<!DOCTYPE html><html lang="zh-CN"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v4.16.19"><title>Blog</title><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono&display=swap" rel="stylesheet"><style>:root{--primary: #2563eb;--text-main: #1f2937;--text-muted: #6b7280;--bg-main: #ffffff;--bg-secondary: #f9fafb;--border: #e5e7eb;--max-width: 800px;--font-sans: "Inter", system-ui, -apple-system, sans-serif;--font-mono: "JetBrains Mono", monospace}*{margin:0;padding:0;box-sizing:border-box}body{font-family:var(--font-sans);color:var(--text-main);background-color:var(--bg-main);line-height:1.6;-webkit-font-smoothing:antialiased}.app-container{display:flex;flex-direction:column;min-height:100vh}.navbar{border-bottom:1px solid var(--border);position:sticky;top:0;background:#fffc;backdrop-filter:blur(8px);z-index:100}.nav-content{max-width:var(--max-width);margin:0 auto;padding:1rem;display:flex;justify-content:space-between;align-items:center}.logo{text-decoration:none;color:var(--text-main);font-weight:800;font-size:1.5rem}.nav-links{list-style:none;display:flex;gap:1.5rem}.nav-links a{text-decoration:none;color:var(--text-muted);font-size:.95rem;font-weight:500;transition:color .2s}.nav-links a:hover{color:var(--primary)}.main-content{flex:1;max-width:var(--max-width);margin:0 auto;width:100%;padding:3rem 1rem}.footer{border-top:1px solid var(--border);background:var(--bg-secondary);padding:2rem 1rem;margin-top:4rem}.footer-content{max-width:var(--max-width);margin:0 auto;text-align:center;color:var(--text-muted);font-size:.9rem}.post-content h1,.post-content h2,.post-content h3{margin-top:2.5rem;margin-bottom:1rem;line-height:1.3}.post-content p{margin-bottom:1.5rem}.post-content img{max-width:100%;height:auto;border-radius:8px;margin:2rem 0}.post-content pre{border-radius:8px;padding:1.25rem;margin-bottom:2rem;font-family:var(--font-mono);font-size:.9rem;overflow-x:auto}.post-content code:not(pre code){background:var(--bg-secondary);padding:.2rem .4rem;border-radius:4px;font-family:var(--font-mono);font-size:.9em}.post-content blockquote{border-left:4px solid var(--primary);padding-left:1.5rem;font-style:italic;color:var(--text-muted);margin:2rem 0}.post-content ul,.post-content ol{margin-bottom:1.5rem;padding-left:1.5rem}.post-content li{margin-bottom:.5rem}
.post-header[data-astro-cid-rl3favg5]{margin-bottom:4rem;text-align:center}.post-date[data-astro-cid-rl3favg5]{display:block;font-size:.875rem;text-transform:uppercase;letter-spacing:.05em;color:var(--text-muted);font-weight:600;margin-bottom:1rem}.post-title[data-astro-cid-rl3favg5]{font-size:3rem;font-weight:800;line-height:1.1;margin-bottom:1.5rem;letter-spacing:-.025em}.post-meta[data-astro-cid-rl3favg5]{display:flex;justify-content:center;gap:1.5rem;font-size:.95rem;color:var(--text-muted)}.tag[data-astro-cid-rl3favg5]{color:var(--primary);margin-right:.5rem}@media (max-width: 640px){.post-title[data-astro-cid-rl3favg5]{font-size:2rem}}
</style></head> <body> <div class="app-container"> <header class="navbar"> <div class="nav-content"> <a href="/" class="logo"> <span class="logo-text">Blog</span> </a> <nav> <ul class="nav-links"> <li><a href="/">Home</a></li> <li><a href="/archive">Archive</a></li> <li><a href="/about">About</a></li> </ul> </nav> </div> </header> <main class="main-content">  <article class="post" data-astro-cid-rl3favg5> <header class="post-header" data-astro-cid-rl3favg5> <time class="post-date" data-astro-cid-rl3favg5> January 10, 2018 </time> <h1 class="post-title" data-astro-cid-rl3favg5></h1> <div class="post-meta" data-astro-cid-rl3favg5>   </div> </header> <div class="post-content" data-astro-cid-rl3favg5> <h2 id="title-golang-returndate-2018-01-10-102111categories-golangtags-golang">title: Golang Return
date: 2018-01-10 10:21:11
categories: golang
tags: [golang]</h2>
<p><a href="https://blog.minio.io/golang-internals-part-2-nice-benefits-of-named-return-values-1e95305c8687">Golang Internals Part 2: Nice benefits of named return values</a></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> objectInfo</span><span style="color:#F97583"> struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	arg1 </span><span style="color:#F97583">int64</span></span>
<span class="line"><span style="color:#E1E4E8">	arg2 </span><span style="color:#F97583">uint64</span></span>
<span class="line"><span style="color:#E1E4E8">	arg3 </span><span style="color:#F97583">string</span></span>
<span class="line"><span style="color:#E1E4E8">	arg4 []</span><span style="color:#F97583">int</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> NoNamedReturnParams</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">i</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">) (</span><span style="color:#B392F0">objectInfo</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">		// Do one thing</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#B392F0"> objectInfo</span><span style="color:#E1E4E8">{}</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">		// Do another thing</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#B392F0"> objectInfo</span><span style="color:#E1E4E8">{}</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 3</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">		// Do one more thing still</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#B392F0"> objectInfo</span><span style="color:#E1E4E8">{}</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Normal return</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#B392F0"> objectInfo</span><span style="color:#E1E4E8">{}</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>actual code that the golang compiler generates</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="plaintext"><code><span class="line"><span>"".NoNamedReturnParams t=1 size=243 args=0x40 locals=0x0</span></span>
<span class="line"><span>0x0000 	TEXT	"".NoNamedReturnParams(SB), $0-64</span></span>
<span class="line"><span>0x0000 	MOVQ	$0, "".~r1+16(FP)</span></span>
<span class="line"><span>0x0009 	LEAQ	"".~r1+24(FP), DI</span></span>
<span class="line"><span>0x000e 	XORPS	X0, X0</span></span>
<span class="line"><span>0x0011 	ADDQ	$-16, DI</span></span>
<span class="line"><span>0x0015 	DUFFZERO	$288</span></span>
<span class="line"><span>0x0028 	MOVQ	"".i+8(FP), AX</span></span>
<span class="line"><span>0x002d 	CMPQ	AX, $1</span></span>
<span class="line"><span>0x0031 	JEQ	$0, 199</span></span>
<span class="line"><span>0x0037 	CMPQ	AX, $2</span></span>
<span class="line"><span>0x003b 	JEQ	$0, 155</span></span>
<span class="line"><span>0x003d 	CMPQ	AX, $3</span></span>
<span class="line"><span>0x0041 	JNE	111</span></span>
<span class="line"><span>0x0043 	MOVQ	"".statictmp_2(SB), AX</span></span>
<span class="line"><span>0x004a 	MOVQ	AX, "".~r1+16(FP)</span></span>
<span class="line"><span>0x004f 	LEAQ	"".~r1+24(FP), DI</span></span>
<span class="line"><span>0x0054 	LEAQ	"".statictmp_2+8(SB), SI</span></span>
<span class="line"><span>0x005b 	DUFFCOPY	$854</span></span>
<span class="line"><span>0x006e 	RET</span></span>
<span class="line"><span>0x006f 	MOVQ	"".statictmp_3(SB), AX</span></span>
<span class="line"><span>0x0076 	MOVQ	AX, "".~r1+16(FP)</span></span>
<span class="line"><span>0x007b 	LEAQ	"".~r1+24(FP), DI</span></span>
<span class="line"><span>0x0080 	LEAQ	"".statictmp_3+8(SB), SI</span></span>
<span class="line"><span>0x0087 	DUFFCOPY	$854</span></span>
<span class="line"><span>0x009a 	RET</span></span>
<span class="line"><span>0x009b 	MOVQ	"".statictmp_1(SB), AX</span></span>
<span class="line"><span>0x00a2 	MOVQ	AX, "".~r1+16(FP)</span></span>
<span class="line"><span>0x00a7 	LEAQ	"".~r1+24(FP), DI</span></span>
<span class="line"><span>0x00ac 	LEAQ	"".statictmp_1+8(SB), SI</span></span>
<span class="line"><span>0x00b3 	DUFFCOPY	$854</span></span>
<span class="line"><span>0x00c6 	RET</span></span>
<span class="line"><span>0x00c7 	MOVQ	"".statictmp_0(SB), AX</span></span>
<span class="line"><span>0x00ce 	MOVQ	AX, "".~r1+16(FP)</span></span>
<span class="line"><span>0x00d3 	LEAQ	"".~r1+24(FP), DI</span></span>
<span class="line"><span>0x00d8 	LEAQ	"".statictmp_0+8(SB), SI</span></span>
<span class="line"><span>0x00df 	DUFFCOPY	$854</span></span>
<span class="line"><span>0x00f2 	RET</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span></code></pre>
<blockquote>
<p>All fine and dandy, but if that looks a bit repetitive to you, you are quite right. Essentially for each of the <code>return</code> statements the object to be returned is more or less allocated/initialized (or more precisely copied via the <code>DUFFCOPY</code>macro).</p>
</blockquote>
<p>naked return feature of golang</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> NamedReturnParams</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">i</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">) (</span><span style="color:#FFAB70">oi</span><span style="color:#B392F0"> objectInfo</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">		// Do one thing</span></span>
<span class="line"><span style="color:#F97583">		return</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">		// Do another thing</span></span>
<span class="line"><span style="color:#F97583">		return</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 3</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">		// Do one more thing still</span></span>
<span class="line"><span style="color:#F97583">		return</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Normal return</span></span>
<span class="line"><span style="color:#F97583">	return</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>It reduces the size of the function down from <code>243</code> to <code>67</code> bytes. Also as an additional benefit you will save some CPU cycles upon exiting out because there is no need anymore to do anything in order to setup the return value.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#6A737D">// parse credentialHeader string into its structured form.</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> parseCredentialHeader</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">credElement</span><span style="color:#F97583"> string</span><span style="color:#E1E4E8">) (</span><span style="color:#FFAB70">ch</span><span style="color:#B392F0"> credentialHeader</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">    creds </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> strings.</span><span style="color:#B392F0">Split</span><span style="color:#E1E4E8">(strings.</span><span style="color:#B392F0">TrimSpace</span><span style="color:#E1E4E8">(credElement), </span><span style="color:#9ECBFF">"="</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#B392F0"> len</span><span style="color:#E1E4E8">(creds) </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">	return</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> creds[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">!=</span><span style="color:#9ECBFF"> "Credential"</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">	return</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    credElements </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> strings.</span><span style="color:#B392F0">Split</span><span style="color:#E1E4E8">(strings.</span><span style="color:#B392F0">TrimSpace</span><span style="color:#E1E4E8">(creds[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">]), </span><span style="color:#9ECBFF">"/"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#B392F0"> len</span><span style="color:#E1E4E8">(credElements) </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 5</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">	return</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#79B8FF"> false</span><span style="color:#6A737D"> /*!isAccessKeyValid(credElements[0])*/</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">	return</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#6A737D">    // Save access key id.</span></span>
<span class="line"><span style="color:#E1E4E8">    cred </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> credentialHeader</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">	accessKey: credElements[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    var</span><span style="color:#E1E4E8"> e </span><span style="color:#F97583">error</span></span>
<span class="line"><span style="color:#E1E4E8">    cred.scope.date, e </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> time.</span><span style="color:#B392F0">Parse</span><span style="color:#E1E4E8">(yyyymmdd, credElements[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">])</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> e </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">	return</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    cred.scope.region </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> credElements[</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> credElements[</span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">!=</span><span style="color:#9ECBFF"> "s3"</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">	return</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    cred.scope.service </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> credElements[</span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> credElements[</span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">!=</span><span style="color:#9ECBFF"> "aws4_request"</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">	return</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    cred.scope.request </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> credElements[</span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> cred</span></span>
<span class="line"><span style="color:#E1E4E8">} </span></span>
<span class="line"></span></code></pre>
<p>隐含的return value的方式</p>
<p>Note that actually the <code>ch</code> variable is a normal local variable just like any other local variable that is defined within the function. And as such you can change its value from the default ‘zero’ state (but of course then the modified version will be returned upon exiting out).</p>
<h4 id="others-uses-of-named-return-values">others uses of named return values</h4>
<p>As pointed out by several persons, another benefit of named return values is the use in closures (i.e. defer statements). Thus one may access the named return value in a function that is called as the result of a <code>defer</code> statement and act accordingly.</p>
<h4 id="conclusion">conclusion</h4>
<p>So we will be gradually adopting named return values more and more, both for new code as well as for existing code.</p>
<p>future to integration with <code>gofmt</code> to modify the source automatically</p> </div> </article>  </main> <footer class="footer"> <div class="footer-content"> <p>&copy; 2026 Liu Weifeng. Built with Astro.</p> </div> </footer> </div> </body></html> 