<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"gqlxj1987.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="DevilKing&#39;s blog">
<meta property="og:url" content="https://gqlxj1987.github.io/page/40/index.html">
<meta property="og:site_name" content="DevilKing&#39;s blog">
<meta property="og:locale">
<meta property="article:author" content="gqlxj1987">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://gqlxj1987.github.io/page/40/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>DevilKing's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">DevilKing's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">冷灯看剑，剑上几分功名？炉香无需计苍生，纵一穿烟逝，万丈云埋，孤阳还照古陵</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://gqlxj1987.github.io/2019/07/01/rest-to-grpc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="gqlxj1987">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="DevilKing's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/01/rest-to-grpc/" class="post-title-link" itemprop="url">Rest to Grpc</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-07-01 18:14:39" itemprop="dateCreated datePublished" datetime="2019-07-01T18:14:39+08:00">2019-07-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/gRPC/" itemprop="url" rel="index"><span itemprop="name">gRPC</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/ye16SG5IdQi-vsIhs43E">原文链接</a></p>
<p>通过 protoc 编译器生成的代码可以确保客户端发送或服务器端接收到的数据是遵循规范的，这样非常有助于调试。我记得有两次我开发的服务因为格式没有经过验证而生成了错误的JSON 数据，这些问题只会在用户界面上表现出来。要想找出问题的根源，我们只能调试前端 JavaScript 代码，而这对于一个不太熟悉 JavaScript 框架的后端开发人员来说这并不容易！</p>
<p>gRPC的调试，不方便</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://gqlxj1987.github.io/2019/07/01/fetching-private-go-module/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="gqlxj1987">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="DevilKing's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/01/fetching-private-go-module/" class="post-title-link" itemprop="url">Fetching Private Go Module</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-07-01 18:03:41" itemprop="dateCreated datePublished" datetime="2019-07-01T18:03:41+08:00">2019-07-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/golang/" itemprop="url" rel="index"><span itemprop="name">golang</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://medium.com/@jwenz723/fetching-private-go-modules-during-docker-build-5b76aa690280">原文链接</a></p>
<p>These problems occur because during the docker build process the git cli does not have credentials to access any private git repositories</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># First stage: build the executable.</span></span><br><span class="line"><span class="keyword">FROM</span> golang:<span class="number">1.12</span>.<span class="number">5</span>-alpine AS builder</span><br><span class="line"></span><br><span class="line"><span class="comment"># git is required to fetch go dependencies</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apk add --no-cache ca-certificates git</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create the user and group files that will be used in the running </span></span><br><span class="line"><span class="comment"># container to run the process as an unprivileged user.</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir /user &amp;&amp; \</span></span><br><span class="line"><span class="bash">    <span class="built_in">echo</span> <span class="string">&#x27;nobody:x:65534:65534:nobody:/:&#x27;</span> &gt; /user/passwd &amp;&amp; \</span></span><br><span class="line"><span class="bash">    <span class="built_in">echo</span> <span class="string">&#x27;nobody:x:65534:&#x27;</span> &gt; /user/group</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy the predefined netrc file into the location that git depends on</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> ./netrc /root/.netrc</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chmod 600 /root/.netrc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set the working directory outside $GOPATH to enable the support for modules.</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /src</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Fetch dependencies first; they are less susceptible to change on every build</span></span><br><span class="line"><span class="comment"># and will therefore be cached for speeding up the next build</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> ./go.mod ./go.sum ./</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> go mod download</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Import the code from the context.</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . .</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Build the executable to `/app`. Mark the build as statically linked.</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> CGO_ENABLED=0 go build \</span></span><br><span class="line"><span class="bash">    -installsuffix <span class="string">&#x27;static&#x27;</span> \</span></span><br><span class="line"><span class="bash">    -o /app .</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Final stage: the running container.</span></span><br><span class="line"><span class="keyword">FROM</span> scratch AS final</span><br><span class="line"></span><br><span class="line"><span class="comment"># Import the user and group files from the first stage.</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=builder /user/group /user/passwd /etc/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Import the Certificate-Authority certificates for enabling HTTPS.</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Import the compiled executable from the first stage.</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=builder /app /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Perform any further action as an unprivileged user.</span></span><br><span class="line"><span class="keyword">USER</span> nobody:nobody</span><br><span class="line"></span><br><span class="line"><span class="comment"># Run the compiled binary.</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">&quot;/app&quot;</span>]</span></span><br></pre></td></tr></table></figure>



<p>cp ./netrc</p>
<p>netrc文件内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">machine github.com</span><br><span class="line">login mygituser</span><br><span class="line">password 12345678901234567890</span><br><span class="line"></span><br><span class="line">machine api.github.com</span><br><span class="line">login mygituser</span><br><span class="line">password 12345678901234567890</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://gqlxj1987.github.io/2019/06/25/goroutine-stack-size-evolve/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="gqlxj1987">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="DevilKing's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/06/25/goroutine-stack-size-evolve/" class="post-title-link" itemprop="url">Goroutine Stack Size Evolve</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-06-25 20:09:36" itemprop="dateCreated datePublished" datetime="2019-06-25T20:09:36+08:00">2019-06-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/golang/" itemprop="url" rel="index"><span itemprop="name">golang</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://medium.com/@blanchon.vincent/go-how-does-the-goroutine-stack-size-evolve-447fc02085e5">原文链接</a></p>
<p>Go provides a light and smart goroutines management. Light because the goroutine stack starts at 2Kb only, and smart since goroutines can grow / shrink automatically according to our needs.</p>
<p>Regarding the size of the stack, we can find it in <code>runtime/stack.go</code> :</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The minimum size of stack used by Go code</span></span><br><span class="line">_StackMin = <span class="number">2048</span></span><br></pre></td></tr></table></figure>



<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   a := <span class="number">1</span></span><br><span class="line">   b := <span class="number">2</span></span><br><span class="line"></span><br><span class="line">   r := max(a, b)</span><br><span class="line">   <span class="built_in">println</span>(<span class="string">`max: `</span>+strconv.Itoa(r))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">max</span><span class="params">(a <span class="keyword">int</span>, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">   <span class="keyword">if</span> a &gt;= b &#123;</span><br><span class="line">      <span class="keyword">return</span> a</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">go build -gcflags -S main.go</span><br><span class="line"></span><br><span class="line">&quot;&quot;.main STEXT size=186 args=0x0 locals=0x70</span><br><span class="line">   0x0000 00000 (/go/src/main.go:5)    TEXT   &quot;&quot;.main(SB), ABIInternal, $112-0</span><br><span class="line">   [...]</span><br><span class="line">   0x00b0 00176 (/go/src/main.go:5) CALL   runtime.morestack_noctxt(SB)</span><br><span class="line">[...]</span><br><span class="line">0x0000 00000 (/go/src/main.go:13)    TEXT   &quot;&quot;.max(SB), NOSPLIT|ABIInternal, $0-24</span><br></pre></td></tr></table></figure>



<p>There are two instructions that involves the stack changes:</p>
<ul>
<li><code>CALL runtime.morestack_noctxt</code>: this method will increase the size of the stack if it needs more.</li>
<li><code>NOSPLIT</code>: this instruction means that the stack overflow check is not needed. It is similar to the <a target="_blank" rel="noopener" href="https://golang.org/cmd/compile/">compiler directive</a> <code>//go:nosplit</code>.</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">runtime: newstack sp=0xc00002e6d8 stack=[0xc00002e000, 0xc00002e800]</span><br><span class="line">copystack gp=0xc000000300 [0xc00002e000 0xc00002e6e0 0xc00002e800] -&gt; [0xc000076000 0xc000076ee0 0xc000077000]/4096</span><br><span class="line">stackfree 0xc00002e000 2048</span><br><span class="line">stack grow done</span><br><span class="line">runtime: newstack sp=0xc000076888 stack=[0xc000076000, 0xc000077000]</span><br><span class="line">copystack gp=0xc000000300 [0xc000076000 0xc000076890 0xc000077000] -&gt; [0xc00003e000 0xc00003f890 0xc000040000]/8192</span><br><span class="line">stackfree 0xc000076000 4096</span><br><span class="line">stack grow done</span><br></pre></td></tr></table></figure>



<p>The strategy to copy the stack into a bigger space is called <a target="_blank" rel="noopener" href="https://docs.google.com/document/d/1wAaf1rYoM4S4gtnPh0zOlGzWtrZFQ5suE8qr2sD8uWQ/pub">contiguous stack</a> as opposed to segmented stack</p>
<p>类似于普通操作系统的segment stacks管理？</p>
<p>rust部分，不采用这种方式，</p>
<ul>
<li>stack thrashing的问题，需要事先分配</li>
<li>FFI，外部code往往都需要large stacks</li>
<li>LLVM libc optimizations and intrinsic fallbacks</li>
</ul>
<p>Instead of segmented stacks we’re going to rely on the OS and MMU to help us map pages lazily</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://gqlxj1987.github.io/2019/06/24/java-fork-join-pool/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="gqlxj1987">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="DevilKing's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/06/24/java-fork-join-pool/" class="post-title-link" itemprop="url">Java Fork Join Pool</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-06-24 18:14:27" itemprop="dateCreated datePublished" datetime="2019-06-24T18:14:27+08:00">2019-06-24</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://gqlxj1987.github.io/2019/06/24/what-happens-when-k8s/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="gqlxj1987">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="DevilKing's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/06/24/what-happens-when-k8s/" class="post-title-link" itemprop="url">What Happens When K8s</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-06-24 14:30:01" itemprop="dateCreated datePublished" datetime="2019-06-24T14:30:01+08:00">2019-06-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/kubernets/" itemprop="url" rel="index"><span itemprop="name">kubernets</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://github.com/jamiehannaford/what-happens-when-k8s">原文链接</a></p>
<p>kubect-&gt;kube apiserver-&gt;etcd-&gt;initializer-&gt;control loops-&gt;kubelet-&gt;wrap up</p>
<h3 id="kubect"><a href="#kubect" class="headerlink" title="kubect"></a>kubect</h3><p>validation and generators -&gt; api groups and version negotiation-&gt; client auth</p>
<p>All attempts to access or change state in the Kubernetes system goes through the API server, which in turns communicates with etcd.</p>
<p>What’s worth pointing out before we continue is that Kubernetes uses a <em>versioned</em> API that is categorised into “API groups”. An API group is meant to categorise similar resources so that they’re easier to reason about.</p>
<p>After kubectl generates the runtime object, it starts to <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/pkg/kubectl/cmd/run.go#L580-L597">find the appropriate API group and version</a> for it and then <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/pkg/kubectl/cmd/run.go#L598">assembles a versioned client</a> that is aware of the various REST semantics for the resource.自动发现机制？</p>
<h3 id="kube-apiserver"><a href="#kube-apiserver" class="headerlink" title="kube-apiserver"></a>kube-apiserver</h3><p>authentication-&gt; authorization-&gt;admission control</p>
<p>As we’ve already mentioned, kube-apiserver is the primary interface that clients and system components use to persist and retrieve cluster state. To perform its function, it needs to be able to verify that the requester is who they say there are. This process is called authentication.</p>
<p>Whilst authorization is focused on answering whether a user has permission, admission controllers intercept the request to ensure that it matches the wider expectations and rules of the cluster. </p>
<p>Admission controllers:</p>
<ul>
<li>InitialResources</li>
<li>LimitRanger</li>
<li>ResourceQuota</li>
</ul>
<h3 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h3><p>Well, there’s a pretty complicated series of steps that happen <em>before</em> any requests are served.</p>
<ol>
<li>When the <code>kube-apiserver</code> binary is run, it <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/cmd/kube-apiserver/app/server.go#L119">creates a server chain</a>, which allows apiserver aggregation. This is basically a way of supporting multiple apiservers (we don’t need to worry about this).</li>
<li>When this happens, a <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/cmd/kube-apiserver/app/server.go#L149">generic apiserver is created</a> that serves as a default implementation.</li>
<li>The generated OpenAPI schema populates the <a target="_blank" rel="noopener" href="https://github.com/kubernetes/apiserver/blob/7001bc4df8883d4a0ec84cd4b2117655a0009b6c/pkg/server/config.go#L149">apiserver’s configuration</a>.</li>
<li>kube-apiserver then iterates over all the API groups specified in the schema and configures a <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/c7a1a061c3dc5acabcc0c35b3b96a6935dccf546/pkg/master/master.go#L410">storage provider</a> for each that serves as a generic storage abstraction. This is what kube-apiserver talks to when it accesses or mutates the state of a resource.</li>
<li>For every API group it also iterates over each of the group versions and <a target="_blank" rel="noopener" href="https://github.com/kubernetes/apiserver/blob/7001bc4df8883d4a0ec84cd4b2117655a0009b6c/pkg/endpoints/groupversion.go#L92">installs the REST mappings</a> for every HTTP route. This allows kube-apiserver to map requests and be able to delegate off to the correct logic once it finds a match.</li>
<li>For our specific use case, a <a target="_blank" rel="noopener" href="https://github.com/kubernetes/apiserver/blob/7001bc4df8883d4a0ec84cd4b2117655a0009b6c/pkg/endpoints/installer.go#L710">POST handler</a> is registered, which in turn will delegate to a <a target="_blank" rel="noopener" href="https://github.com/kubernetes/apiserver/blob/7001bc4df8883d4a0ec84cd4b2117655a0009b6c/pkg/endpoints/handlers/create.go#L37">create resource handler</a>.</li>
</ol>
<p>Now let’s imagine our HTTP request has flown in:</p>
<ol>
<li>If the handler chain can match the request to a set pattern (i.e. to the routes we registered), it will <a target="_blank" rel="noopener" href="https://github.com/kubernetes/apiserver/blob/7001bc4df8883d4a0ec84cd4b2117655a0009b6c/pkg/server/handler.go#L143">dispatch the dedicated handler</a> that was registered for the route. Otherwise it fall back to a <a target="_blank" rel="noopener" href="https://github.com/kubernetes/apiserver/blob/7001bc4df8883d4a0ec84cd4b2117655a0009b6c/pkg/server/mux/pathrecorder.go#L248">path-based handler</a> (this is what happens when you call <code>/apis</code>). If no handlers are registered for that path, a <a target="_blank" rel="noopener" href="https://github.com/kubernetes/apiserver/blob/7001bc4df8883d4a0ec84cd4b2117655a0009b6c/pkg/server/mux/pathrecorder.go#L254">not found handler</a> is invoked which results in a 404.</li>
<li>Luckily for us, we have a registered route called <a target="_blank" rel="noopener" href="https://github.com/kubernetes/apiserver/blob/7001bc4df8883d4a0ec84cd4b2117655a0009b6c/pkg/endpoints/handlers/create.go#L37"><code>createHandler</code></a>! What does it do? Well it will first decode the HTTP request and perform basic validation, such as ensuring the JSON they provided correlates with our expectation of the versioned API resource.</li>
<li>Auditing and final admission <a target="_blank" rel="noopener" href="https://github.com/kubernetes/apiserver/blob/7001bc4df8883d4a0ec84cd4b2117655a0009b6c/pkg/endpoints/handlers/create.go#L93-L104">will occur</a>.</li>
<li>The resource will be <a target="_blank" rel="noopener" href="https://github.com/kubernetes/apiserver/blob/7001bc4df8883d4a0ec84cd4b2117655a0009b6c/pkg/endpoints/handlers/create.go#L111">saved to etcd</a> by <a target="_blank" rel="noopener" href="https://github.com/kubernetes/apiserver/blob/19667a1afc13cc13930c40a20f2c12bbdcaaa246/pkg/registry/generic/registry/store.go#L327">delegating to the storage provider</a>. Usually the etcd key will be the form of <code>&lt;namespace&gt;/&lt;name&gt;</code>, but this is configurable.</li>
<li>Any create errors are caught and, finally, the storage provider performs a <code>get</code> call to ensure the object was actually created. It then invokes any post-create handlers and decorators if additional finalization is required.</li>
<li>The HTTP response <a target="_blank" rel="noopener" href="https://github.com/kubernetes/apiserver/blob/7001bc4df8883d4a0ec84cd4b2117655a0009b6c/pkg/endpoints/handlers/create.go#L131-L142">is constructed</a> and sent back.</li>
</ol>
<h3 id="initializers"><a href="#initializers" class="headerlink" title="initializers"></a>initializers</h3><p>An initializer is a controller that is associated with a resource type and performs logic on the resource before it’s made available to the outside world</p>
<p><code>initializerConfiguration</code> objects allow you to declare which initializers should run for certain resource types. After creating this config, it will append <code>custom-pod-initializer</code> to every Pod’s <code>metadata.initializers.pending</code> field.</p>
<h3 id="Control-loops"><a href="#Control-loops" class="headerlink" title="Control loops"></a>Control loops</h3><p>deployments controller-&gt; replicaSets controller-&gt; informers -&gt; scheduler</p>
<p> When we think about it, a Deployment is really just a collection of ReplicaSets, and a ReplicaSet is a collection of Pods.</p>
<p>This handler will be executed when our Deployment first becomes available and will start by <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/pkg/controller/deployment/deployment_controller.go#L170">adding the object to an internal work queue</a>.</p>
<p>it will begin a <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/pkg/controller/deployment/sync.go#L385">scaling process</a> to start resolving state. It does this by rolling out (e.g. creating) a ReplicaSet resource, assigning it a label selector, and giving it the revision number of 1. label selector?</p>
<p>the Deployments controller created our Deployment’s first ReplicaSet but we still have no Pods. This is where the ReplicaSet controller comes into play! Its job is to monitor the lifecycle of ReplicaSets and their dependent resources (Pods). Like most other controllers, it does this by triggering handlers on certain events</p>
<p>Kubernetes enforces object hierarchies through Owner References (a field in the child resource where it references the ID of its parent).</p>
<p>An informer is a pattern that allows controllers to subscribe to storage events and easily list resources they’re interested in.</p>
<p>Apart from providing an abstraction which is nice to work with, it also takes care of a lot of the nuts and bolts such as caching (caching is important because it reduces unnecessary kube-apiserver connections, and reduces duplicate serialization costs server- and controller-side).关于caching的含义？消息应该不能用cache才对</p>
<p>What’s interesting is that both predicate and priority functions are extensible and can be defined by using the <code>--policy-config-file</code> flag. This introduces a degree of flexibility. 调度的灵活性</p>
<h3 id="kubelet"><a href="#kubelet" class="headerlink" title="kubelet"></a>kubelet</h3><p>pod sync-&gt; CRI and pause containers-&gt; cni and pod networking-&gt; inter-host networking-&gt; container startup</p>
<p>The kubelet is an agent that runs on every node in a Kubernetes cluster and is responsible for, among other things, managing the lifecycle of Pods.</p>
<p>A useful way of thinking about the kubelet is again like a controller! It queries Pods from kube-apiserver every 20 seconds (this is configurable), filtering the ones whose <code>NodeName</code> <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/3b66adb8bc6929e1205bcb2bc32f380c39be8381/pkg/kubelet/config/apiserver.go#L34">matches the name</a> of the node the kubelet is running on. Once it has that list, it detects new additions by comparing against its own internal cache and begins to synchronise state if any discrepencies exist. </p>
<p>In this runtime, creating a sandbox involves creating a “pause” container. A pause container serves like a parent for all of the other containers in the Pod since it hosts a lot of the pod-level resources that workload containers will end up using. </p>
<p>The “pause” container provides a way to host all of these namespaces and allow child containers to share them.</p>
<h3 id="Wrap-up"><a href="#Wrap-up" class="headerlink" title="Wrap-up"></a>Wrap-up</h3>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/39/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/39/">39</a><span class="page-number current">40</span><a class="page-number" href="/page/41/">41</a><span class="space">&hellip;</span><a class="page-number" href="/page/132/">132</a><a class="extend next" rel="next" href="/page/41/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="gqlxj1987"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">gqlxj1987</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">656</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">239</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">245</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
<div class="site-state-wrap motion-element subtitle">冷灯看剑，剑上几分功名？炉香无需计苍生，纵一穿烟逝，万丈云埋，孤阳还照古陵</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">gqlxj1987</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
