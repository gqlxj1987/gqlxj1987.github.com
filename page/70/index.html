<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"gqlxj1987.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="DevilKing&#39;s blog">
<meta property="og:url" content="https://gqlxj1987.github.io/page/70/index.html">
<meta property="og:site_name" content="DevilKing&#39;s blog">
<meta property="og:locale">
<meta property="article:author" content="gqlxj1987">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://gqlxj1987.github.io/page/70/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>DevilKing's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">DevilKing's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">冷灯看剑，剑上几分功名？炉香无需计苍生，纵一穿烟逝，万丈云埋，孤阳还照古陵</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://gqlxj1987.github.io/2018/11/16/spark-sql-window/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="gqlxj1987">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="DevilKing's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/11/16/spark-sql-window/" class="post-title-link" itemprop="url">Spark Sql Join部分</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-16 10:21:52" itemprop="dateCreated datePublished" datetime="2018-11-16T10:21:52+08:00">2018-11-16</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/spark/" itemprop="url" rel="index"><span itemprop="name">spark</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>spark 1.6.2 -&gt; spark 2.2</p>
<p>内存中的数据组织形式</p>
<p><img src="https://user-images.githubusercontent.com/22542670/26998244-18ed1b40-4d9f-11e7-897d-5d2b032c3001.png" alt="memory"></p>
<p>在内存中，改成了以列式存储为主</p>
<p>(1) 与numpy或者tensorflow接入时可实现zero serialization（零序列化）</p>
<p>(2) 与Spark的in-memory columnar-cache无缝兼容</p>
<p>(3) 更利于压缩技术的引入</p>
<h4 id="CBO"><a href="#CBO" class="headerlink" title="CBO"></a>CBO</h4><p>基于成本的优化器CBO，是根据计算出的所有可能的物理计划的代价，选择代价最小的物理执行计划。关键点在于能评估一个物理执行计划的代价。</p>
<ul>
<li><p>HashJoin中build side and probe side中的问题</p>
</li>
<li><p>在 Spark SQL 中，Join主要有两种执行方式，Shuffle-based Join, BroadcastJoin。Shuffle-based Join会有Shuffle，代价比较。BroadcastJoin不需要shuffle，但要求至少有一张表足够小，这样就能通过Broadcast机制，广播到每个Executor中。</p>
<p>如下图所示，在没CBO的情况下，SparkSQL通过spark.sql.autoBroadcastJoinThreshold来判断是否选择BroadcastJoin（默认值为10MB）。如果判断基于原始表大小，会选用SortMergeJoin。</p>
<p>在有CBO的情况下，经过Filter后的Table 2的大小正好满足小于10MB的情况下，会正确地采用性能更好的BroadcastJoin。</p>
</li>
</ul>
<p><img src="http://www.jasongj.com/img/spark/spark3_cbo/spark_cbo_join_type.png" alt="broadcast"></p>
<ul>
<li>并行的join的情况</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://gqlxj1987.github.io/2018/11/14/tensorflow-large-batch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="gqlxj1987">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="DevilKing's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/11/14/tensorflow-large-batch/" class="post-title-link" itemprop="url">Tensorflow Large batch</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-14 22:53:58" itemprop="dateCreated datePublished" datetime="2018-11-14T22:53:58+08:00">2018-11-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tensorflow/" itemprop="url" rel="index"><span itemprop="name">tensorflow</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>GPU不够的情况下，</p>
<p>在TensorFlow上，我们可以比较方便地定制一个optimizer来实现这种操作，封装一下实际的optimizer，实际上做梯度累加和延迟更新两部就好了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LazyUpdateOptimizer</span>(tf.train.Optimizer):</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, optimizer, batch_size=<span class="number">1</span>,</span></span><br><span class="line"><span class="params">                 use_locking=<span class="literal">True</span>, name=<span class="string">&quot;LazyUpdateOptimizer&quot;</span></span>):</span><br><span class="line"> </span><br><span class="line">        tf.train.Optimizer.__init__(self, use_locking=use_locking, name=name)</span><br><span class="line"> </span><br><span class="line">        self._name = name</span><br><span class="line">        self._batch_size = batch_size</span><br><span class="line">        self._grad_cache = &#123;&#125;</span><br><span class="line">        self._optimizer = optimizer</span><br><span class="line">        self._<span class="built_in">vars</span> = []</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(self._name):</span><br><span class="line">            self._batch_count_variable = \</span><br><span class="line">                tf.get_variable(name=<span class="string">&quot;batch_count&quot;</span>,</span><br><span class="line">                                shape=[],</span><br><span class="line">                                dtype=tf.int64,</span><br><span class="line">                                initializer=tf.constant_initializer(self._batch_size),</span><br><span class="line">                                collections=[tf.GraphKeys.LOCAL_VARIABLES])</span><br><span class="line">            self._<span class="built_in">vars</span>.append(self._batch_count_variable)</span><br><span class="line"> </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">optimizer</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self._optimizer</span><br><span class="line"> </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">name</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self._name</span><br><span class="line"> </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">batch_size</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self._batch_size</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_initializer</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> tf.group([_.initializer <span class="keyword">for</span> _ <span class="keyword">in</span> self._<span class="built_in">vars</span>])</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">apply_gradients</span>(<span class="params">self, grads_and_vars, global_step=<span class="literal">None</span>, name=<span class="literal">None</span></span>):</span><br><span class="line">        scope_name = self._name</span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            scope_name += <span class="string">&quot;_&quot;</span> + name</span><br><span class="line"> </span><br><span class="line">        cached_grads = []</span><br><span class="line">        <span class="keyword">for</span> grad, var <span class="keyword">in</span> grads_and_vars:</span><br><span class="line">            <span class="keyword">if</span> grad <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"> </span><br><span class="line">            <span class="keyword">if</span> var <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> var <span class="keyword">not</span> <span class="keyword">in</span> self._grad_cache:</span><br><span class="line">                <span class="keyword">with</span> tf.variable_scope(scope_name):</span><br><span class="line">                    <span class="keyword">with</span> tf.colocate_with(var):</span><br><span class="line">                        cached_grad = tf.get_variable(name=var.name.split(<span class="string">&quot;:&quot;</span>)[<span class="number">0</span>] + <span class="string">&quot;_grad_cache&quot;</span>,</span><br><span class="line">                                                      dtype=var.dtype,</span><br><span class="line">                                                      shape=var.shape,</span><br><span class="line">                                                      initializer=tf.zeros_initializer(),</span><br><span class="line">                                                      trainable=<span class="literal">False</span>,</span><br><span class="line">                                                      collections=[tf.GraphKeys.LOCAL_VARIABLES])</span><br><span class="line">                        self._<span class="built_in">vars</span>.append(cached_grad)</span><br><span class="line">                self._grad_cache[var] = cached_grad</span><br><span class="line">            cached_grads.append(self._grad_cache[var])</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">with</span> tf.name_scope(scope_name):</span><br><span class="line">            cache_gradients_op = self.__cache_gradients(grads_and_vars, cached_grads)</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">with</span> tf.control_dependencies([cache_gradients_op]):</span><br><span class="line">                apply_op = tf.cond(</span><br><span class="line">                    tf.equal(self._batch_count_variable, <span class="number">0</span>),</span><br><span class="line">                    true_fn=<span class="keyword">lambda</span>: self.__actual_apply_gradients(grads_and_vars, global_step=global_step),</span><br><span class="line">                    false_fn=<span class="keyword">lambda</span>: tf.no_op())</span><br><span class="line">                <span class="keyword">with</span> tf.control_dependencies([apply_op]):</span><br><span class="line">                    <span class="keyword">return</span> tf.no_op()</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__cache_gradients</span>(<span class="params">self, grads_and_vars, cached_grads</span>):</span><br><span class="line">        update_ops = []</span><br><span class="line">        <span class="keyword">with</span> tf.name_scope(<span class="string">&quot;cache_grad&quot;</span>):</span><br><span class="line">            <span class="keyword">for</span> (grad, var), cached_grad <span class="keyword">in</span> itertools.izip(grads_and_vars, cached_grads):</span><br><span class="line">                <span class="keyword">with</span> tf.colocate_with(cached_grad):</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">isinstance</span>(grad, tf.Tensor):</span><br><span class="line">                        update_op = tf.assign_add(cached_grad, grad)</span><br><span class="line">                    <span class="keyword">elif</span> <span class="built_in">isinstance</span>(grad, tf.IndexedSlices):</span><br><span class="line">                        update_op = tf.scatter_add(cached_grad, grad.indices, grad.values)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line"> </span><br><span class="line">                update_ops.append(update_op)</span><br><span class="line">            <span class="keyword">with</span> tf.control_dependencies([tf.group(update_ops, name=<span class="string">&quot;record_gradients&quot;</span>)]):</span><br><span class="line">                <span class="keyword">return</span> tf.assign_sub(self._batch_count_variable, <span class="number">1</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__actual_apply_gradients</span>(<span class="params">self, grads_and_vars, global_step=<span class="literal">None</span></span>):</span><br><span class="line">        actual_grads_and_vars = [(self._grad_cache[var], var) <span class="keyword">for</span> grad, var <span class="keyword">in</span> grads_and_vars <span class="keyword">if</span> grad <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>]</span><br><span class="line"> </span><br><span class="line">        apply_op = self._optimizer.apply_gradients(actual_grads_and_vars, global_step=global_step)</span><br><span class="line">        <span class="keyword">with</span> tf.control_dependencies([apply_op]):</span><br><span class="line">            reset_ops = [tf.assign(self._batch_count_variable, self._batch_size)]</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">for</span> grad, var <span class="keyword">in</span> actual_grads_and_vars:</span><br><span class="line">                reset_ops.append(tf.assign(self._grad_cache[var], tf.zeros_like(var)))</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">with</span> tf.control_dependencies(reset_ops):</span><br><span class="line">                <span class="keyword">return</span> tf.no_op()</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://gqlxj1987.github.io/2018/11/13/jianlai/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="gqlxj1987">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="DevilKing's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/11/13/jianlai/" class="post-title-link" itemprop="url">剑来的一</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-13 23:50:15" itemprop="dateCreated datePublished" datetime="2018-11-13T23:50:15+08:00">2018-11-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/weekly/" itemprop="url" rel="index"><span itemprop="name">weekly</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>以一贯之</p>
<p>一视同仁</p>
<p>一往无前</p>
<hr>
<p>本周工作：</p>
<ul>
<li>完成featureGraph部分的第二版的接入</li>
<li>了解在线预估部分，尤其是新版fe部分</li>
<li>写一些文档</li>
</ul>
<p>本周所得：</p>
<ul>
<li>代码的合理性以及自测性部分</li>
<li>捡起来code review</li>
</ul>
<p>下周：</p>
<ul>
<li>tuningEntryPoint框架部分的优化</li>
<li>在线预估方案的一些详细设计部分</li>
</ul>
<p>不出意外的，还是哭了，还是压力太大。。。哎。。。还是静心地照顾好，虽然做不到像陈平安一样牛，但好歹也能尽量去做到以一贯之，不要有所放松和松懈，求一个心安，也求一个顺心意</p>
<p>工作上，感觉有些放松，不能因为做完了一个迭代就以为自己上手了，自己的那么多的bug，还有设计上的遗漏，不正是表示自己还是远远不够。。。然后下一个迭代就歇菜了。。。还是把握不了节奏，哎，尽力去做吧，也有了最坏的打算，虽然做不了什么，但起码不要留下什么遗憾，尽力去完成。。。</p>
<p>锻炼又翘了。。。都一个月了，不能再翘了23333</p>
<p>jenkins的源码分析部分，争取11月底能够分享出来。。。尽力去加油了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://gqlxj1987.github.io/2018/11/13/scheduling-notebook/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="gqlxj1987">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="DevilKing's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/11/13/scheduling-notebook/" class="post-title-link" itemprop="url">notebook的调度</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-13 22:26:33" itemprop="dateCreated datePublished" datetime="2018-11-13T22:26:33+08:00">2018-11-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/scheduling/" itemprop="url" rel="index"><span itemprop="name">scheduling</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://medium.com/netflix-techblog/scheduling-notebooks-348e6c14cfd6">原文链接</a></p>
<p>We’re currently in the process of migrating all <strong>10,000</strong> of the scheduled jobs running on the Netflix Data Platform to use notebook-based execution</p>
<p><strong>Notebooks are, in essence, managed JSON documents with a simple interface to execute code within.</strong></p>
<p>Notebooks pose a lot of challenges: they’re frequently changed, their cell outputs need not match the code, they’re difficult to test, and there’s no easy way to dynamically configure their execution. Furthermore, you need a notebook server to run them, which creates architectural dependencies to facilitate execution.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://gqlxj1987.github.io/2018/11/13/virtual-memory/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="gqlxj1987">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="DevilKing's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/11/13/virtual-memory/" class="post-title-link" itemprop="url">算子虚存</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-13 21:58:29" itemprop="dateCreated datePublished" datetime="2018-11-13T21:58:29+08:00">2018-11-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>首先是hadoop部分涉及到的虚存问题</p>
<p>关于虚存限制，Hadoop 有两个参数控制，第一个参数决定是否打开虚存检查，默认为 true，第二个参数指出虚存的 Limit 的计算规则是申请实存的 2.1 倍，这解释了为什么实存设置的小了之后虚存也小了。 </p>
<table>
<thead>
<tr>
<th>yarn.nodemanager.vmem-check-enabled</th>
<th>true</th>
<th>Whether virtual memory limits will be enforced for containers.</th>
</tr>
</thead>
<tbody><tr>
<td>yarn.nodemanager.vmem-pmem-ratio</td>
<td>2.1</td>
<td>Ratio between virtual memory to physical memory when setting memory limits for containers. Container allocations are expressed in terms of physical memory, and virtual memory usage is allowed to exceed this allocation by this ratio.</td>
</tr>
</tbody></table>
<h3 id="什么是虚存"><a href="#什么是虚存" class="headerlink" title="什么是虚存"></a>什么是虚存</h3><p>虚存本质上是 OS 对内存资源的超售，技术上来说从 OS 角度有 Demand Paging，从进程角度有 Overcommit。而 Overcommit 是 OOM 的根源，内核对进程对内存的使用做了较为乐观的估计和假设，所以像 JVM 这种一起来就申请 (malloc) 巨大内存的情况虽然很多，但由于 Overcommit 机制所以能很好的运行。 又因为这种假设并不能放之四海而皆准，所以当遇到进程真的挤兑资源的时候(与 Overcommit 假设不符)，操作系统会通过 OOM - Killer 机制来挽救。挽救的方式是使用一些特殊的策略来随机的杀死进程，在进程的角度看到的就是跑的好好地被 OOM Killed 了。 </p>
<p>当然，日常使用中还存在另一种 OOM，不同于 Overcommit 策略被挤兑时才出现，在 CGroup 生效的时候进程通过 cgroup 与内核协商了最大的资源限制，一旦 RSS(实存) 超过此限制后同样会被 OOM Killed。 </p>
<p><a target="_blank" rel="noopener" href="http://linuxperf.com/?p=102">理解linux的memory overcommit</a></p>
<p>理解memory overcommit的关键：commit(或overcommit)针对的是内存申请，内存申请不等于内存分配，内存只在实际用到的时候才分配。</p>
<p>内核参数 vm.overcommit_memory 接受三种取值：</p>
<ul>
<li>0 – Heuristic overcommit handling. 这是缺省值，它允许overcommit，但过于明目张胆的overcommit会被拒绝，比如malloc一次性申请的内存大小就超过了系统总内存。Heuristic的意思是“试探式的”，内核利用某种算法（对该算法的详细解释请看文末）猜测你的内存申请是否合理，它认为不合理就会拒绝overcommit。</li>
<li>1 – Always overcommit. 允许overcommit，对内存申请来者不拒。</li>
<li>2 – Don’t overcommit. 禁止overcommit。</li>
</ul>
<p><em>“sar -r”是查看内存使用状况的常用工具，它的输出结果中有两个与overcommit有关，kbcommit 和 %commit：</em><br><em>kbcommit对应&#x2F;proc&#x2F;meminfo中的 Committed_AS；</em><br><em>%commit的计算公式并没有采用 CommitLimit作分母，而是Committed_AS&#x2F;(MemTotal+SwapTotal)，意思是_内存申请_占_物理内存与交换区之和_的百分比。</em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sar -r</span> </span><br><span class="line"> </span><br><span class="line">05:00:01 PM kbmemfree kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit  kbactive   kbinact   kbdirty</span><br><span class="line">05:10:01 PM    160576   3648460     95.78         0   1846212   4939368     62.74   1390292   1854880         4</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/69/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/69/">69</a><span class="page-number current">70</span><a class="page-number" href="/page/71/">71</a><span class="space">&hellip;</span><a class="page-number" href="/page/132/">132</a><a class="extend next" rel="next" href="/page/71/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="gqlxj1987"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">gqlxj1987</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">660</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">239</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">247</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
<div class="site-state-wrap motion-element subtitle">冷灯看剑，剑上几分功名？炉香无需计苍生，纵一穿烟逝，万丈云埋，孤阳还照古陵</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">gqlxj1987</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
