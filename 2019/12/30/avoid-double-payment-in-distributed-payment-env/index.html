<!DOCTYPE html><html lang="zh-CN"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v4.16.19"><title>Avoid double payment in distributed payment env | Blog</title><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono&display=swap" rel="stylesheet"><style>:root{--primary: #2563eb;--text-main: #1f2937;--text-muted: #6b7280;--bg-main: #ffffff;--bg-secondary: #f9fafb;--border: #e5e7eb;--max-width: 800px;--font-sans: "Inter", system-ui, -apple-system, sans-serif;--font-mono: "JetBrains Mono", monospace}*{margin:0;padding:0;box-sizing:border-box}body{font-family:var(--font-sans);color:var(--text-main);background-color:var(--bg-main);line-height:1.6;-webkit-font-smoothing:antialiased}.app-container{display:flex;flex-direction:column;min-height:100vh}.navbar{border-bottom:1px solid var(--border);position:sticky;top:0;background:#fffc;backdrop-filter:blur(8px);z-index:100}.nav-content{max-width:var(--max-width);margin:0 auto;padding:1rem;display:flex;justify-content:space-between;align-items:center}.logo{text-decoration:none;color:var(--text-main);font-weight:800;font-size:1.5rem}.nav-links{list-style:none;display:flex;gap:1.5rem}.nav-links a{text-decoration:none;color:var(--text-muted);font-size:.95rem;font-weight:500;transition:color .2s}.nav-links a:hover{color:var(--primary)}.main-content{flex:1;max-width:var(--max-width);margin:0 auto;width:100%;padding:3rem 1rem}.footer{border-top:1px solid var(--border);background:var(--bg-secondary);padding:2rem 1rem;margin-top:4rem}.footer-content{max-width:var(--max-width);margin:0 auto;text-align:center;color:var(--text-muted);font-size:.9rem}.post-content h1,.post-content h2,.post-content h3{margin-top:2.5rem;margin-bottom:1rem;line-height:1.3}.post-content p{margin-bottom:1.5rem}.post-content img{max-width:100%;height:auto;border-radius:8px;margin:2rem 0}.post-content pre{border-radius:8px;padding:1.25rem;margin-bottom:2rem;font-family:var(--font-mono);font-size:.9rem;overflow-x:auto}.post-content code:not(pre code){background:var(--bg-secondary);padding:.2rem .4rem;border-radius:4px;font-family:var(--font-mono);font-size:.9em}.post-content blockquote{border-left:4px solid var(--primary);padding-left:1.5rem;font-style:italic;color:var(--text-muted);margin:2rem 0}.post-content ul,.post-content ol{margin-bottom:1.5rem;padding-left:1.5rem}.post-content li{margin-bottom:.5rem}
.post-header[data-astro-cid-rl3favg5]{margin-bottom:4rem;text-align:center}.post-date[data-astro-cid-rl3favg5]{display:block;font-size:.875rem;text-transform:uppercase;letter-spacing:.05em;color:var(--text-muted);font-weight:600;margin-bottom:1rem}.post-title[data-astro-cid-rl3favg5]{font-size:3rem;font-weight:800;line-height:1.1;margin-bottom:1.5rem;letter-spacing:-.025em}.post-meta[data-astro-cid-rl3favg5]{display:flex;justify-content:center;gap:1.5rem;font-size:.95rem;color:var(--text-muted)}.tag[data-astro-cid-rl3favg5]{color:var(--primary);margin-right:.5rem}@media (max-width: 640px){.post-title[data-astro-cid-rl3favg5]{font-size:2rem}}
</style></head> <body> <div class="app-container"> <header class="navbar"> <div class="nav-content"> <a href="/" class="logo"> <span class="logo-text">Blog</span> </a> <nav> <ul class="nav-links"> <li><a href="/">Home</a></li> <li><a href="/archive">Archive</a></li> <li><a href="/about">About</a></li> </ul> </nav> </div> </header> <main class="main-content">  <article class="post" data-astro-cid-rl3favg5> <header class="post-header" data-astro-cid-rl3favg5> <time class="post-date" data-astro-cid-rl3favg5> December 30, 2019 </time> <h1 class="post-title" data-astro-cid-rl3favg5>Avoid double payment in distributed payment env</h1> <div class="post-meta" data-astro-cid-rl3favg5>  <div class="meta-item tags" data-astro-cid-rl3favg5> <span class="tag" data-astro-cid-rl3favg5>#distributed</span> </div> </div> </header> <div class="post-content" data-astro-cid-rl3favg5> <p><a href="https://medium.com/airbnb-engineering/avoiding-double-payments-in-a-distributed-payments-system-2981f6b070bb">原文链接</a></p>
<p>There are <a href="https://en.wikipedia.org/wiki/Eventual_consistency#Conflict_resolution">three different common techniques</a> used in distributed systems to achieve <a href="https://en.wikipedia.org/wiki/Eventual_consistency"><strong>eventual consistency</strong></a>: <a href="https://docs.datastax.com/en/cassandra/3.0/cassandra/operations/opsRepairNodesReadRepair.html">read repair</a>, write repair, and asynchronous repair.</p>
<p>Asynchronous repair involves the server being responsible for running  data consistency checks, such as table scans, lambda functions, and cron jobs. Additionally, asynchronous notifications from the server to the  client are widely used in the payments industry to force consistency on  the client side.</p>
<p><strong>write repair</strong>, where every write call from the client to the server attempts to repair an inconsistent, broken state.</p>
<p>By design, idempotency safely allows multiple identical calls from clients using an <strong>auto-retry mechanism</strong> for an API to achieve eventual consistency.</p>
<p>it offers low latency while still providing clean separation between  high-velocity product code and low-velocity system management code.</p>
<ul>
<li>An <strong>idempotency key</strong> is passed into the framework, representing a single idempotent request</li>
<li>Tables of idempotency information, always read and written from a <strong>sharded master</strong> database (for <a href="https://en.wikipedia.org/wiki/Consistency_(database_systems)">consistency</a>)</li>
<li>Database transactions are combined in different parts of the codebase to ensure <a href="https://en.wikipedia.org/wiki/Atomicity_(database_systems)">atomicity</a>, using <a href="https://docs.oracle.com/javase/tutorial/java/javaOO/lambdaexpressions.html">Java lambdas</a></li>
<li>Error responses are classified as “<strong>retryable</strong>” or “<strong>non-retryable</strong>“</li>
</ul>
<p>Orpheus is centered around the assumption that almost every standard API request can be separated into <strong>three distinct phases</strong>: Pre-RPC, RPC, and Post-RPC.</p>
<ol>
<li><strong>Pre-RPC:</strong> Details of the payment request are recorded in the database.</li>
<li><strong>RPC:</strong> The request is made live to the external service over network and the  response is received. This is a place to do one or more idempotent  computations or RPCs (for example, query service for the status of a  transaction first if it’s a retry-attempt).</li>
<li><strong>Post-RPC:</strong> Details of the response from the external service are recorded in the  database, including its successfulness and whether a bad request is <strong>retryable</strong> or not.</li>
</ol>
<p>To maintain data integrity, we adhere to <strong>two simple ground rules</strong>:</p>
<ol>
<li><strong>No service interaction over networks in Pre and Post-RPC phases</strong></li>
<li><strong>No database interactions in the RPC phases</strong></li>
</ol>
<p>针对pre-RPC和post-RPC的database操作进行合并。every database commit in each of the Pre-RPC and Post-RPC phases is <strong>combined into a single database transaction</strong>. This ensures atomicity — entire units of work (here the Pre-RPC and Post-RPC phases) can fail or succeed as a unit <strong>consistently</strong>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#F97583">public</span><span style="color:#E1E4E8"> Response </span><span style="color:#B392F0">processPayment</span><span style="color:#E1E4E8">(InitiatePaymentRequest request, UriInfo uriInfo)</span></span>
<span class="line"><span style="color:#E1E4E8">   throws YourCustomException {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583"> return</span><span style="color:#E1E4E8"> orpheusManager.</span><span style="color:#B392F0">process</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">     request.</span><span style="color:#B392F0">getIdempotencyKey</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">     uriInfo,</span></span>
<span class="line"><span style="color:#6A737D">     // 1. Pre-RPC</span></span>
<span class="line"><span style="color:#E1E4E8">     () </span><span style="color:#F97583">-></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">       // Record payment request information from the request object</span></span>
<span class="line"><span style="color:#E1E4E8">       PaymentRequestResource paymentRequestResource </span><span style="color:#F97583">=</span><span style="color:#B392F0"> recordPaymentRequest</span><span style="color:#E1E4E8">(request);</span></span>
<span class="line"><span style="color:#F97583">       return</span><span style="color:#E1E4E8"> Optional.</span><span style="color:#B392F0">of</span><span style="color:#E1E4E8">(paymentRequestResource);</span></span>
<span class="line"><span style="color:#E1E4E8">     },</span></span>
<span class="line"><span style="color:#6A737D">     // 2. RPC</span></span>
<span class="line"><span style="color:#E1E4E8">     (isRetry, paymentRequest) </span><span style="color:#F97583">-></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">       return</span><span style="color:#B392F0"> executePayment</span><span style="color:#E1E4E8">(paymentRequest, isRetry);</span></span>
<span class="line"><span style="color:#E1E4E8">     },</span></span>
<span class="line"><span style="color:#6A737D">     // 3. Post RPC - record response information to database</span></span>
<span class="line"><span style="color:#E1E4E8">     (isRetry, paymentResponse) </span><span style="color:#F97583">-></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">       return</span><span style="color:#B392F0"> recordPaymentResponse</span><span style="color:#E1E4E8">(paymentResponse);</span></span>
<span class="line"><span style="color:#E1E4E8">     });</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>FSM state machine</p>
<p>针对retry和noretry的情况进行分类</p>
<p><img src="https://miro.medium.com/max/3568/1*_q2kiqlR69N_Tybu37Px2Q.png" alt="retry or no-retry"></p>
<p>Choosing an idempotency key is crucial — the client can choose either to have <strong>request-level</strong> idempotency or <strong>entity-level</strong> idempotency based on what key to use.</p>
<p>each api request has an expiring lease</p>
<p>A lease comes with an expiration to cover the scenario where there are timeouts on the server side.</p>
<p>由于replica lag的问题，尽量不要使用replica database</p> </div> </article>  </main> <footer class="footer"> <div class="footer-content"> <p>&copy; 2026 Liu Weifeng. Built with Astro.</p> </div> </footer> </div> </body></html> 