<!DOCTYPE html><html lang="zh-CN"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v4.16.19"><meta name="description" content="Avoid double payment in distributed payment env"><title>Avoid double payment in distributed payment env</title><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet"><link rel="stylesheet" href="/_astro/_title_.U5p-WJ3X.css"><script type="module">const e=()=>{document.querySelectorAll(".animate").forEach((t,s)=>{setTimeout(()=>{t.classList.add("show")},s*150)})};e();document.addEventListener("astro:after-swap",e);
</script></head> <body> <header> <div class="mx-auto max-w-screen-sm px-5">  <div class="flex flex-wrap gap-y-2 justify-between"> <a href="/" class="font-semibold hover:underline underline-offset-2">
Blog
</a> <nav class="flex gap-1">  <a href="/archive" class="hover:underline underline-offset-2"> Archive </a> <span>/</span> <a href="/tags" class="hover:underline underline-offset-2"> Tags </a> <span>/</span> <a href="/categories" class="hover:underline underline-offset-2"> Categories </a> <span>/</span> <a href="/about" class="hover:underline underline-offset-2"> About </a>  </nav> </div>  </div> </header> <main>  <div class="mx-auto max-w-screen-sm px-5">  <div class="animate"> <a href="/archive" class="hover:underline underline-offset-2">
← Back to archive
</a> </div> <div class="space-y-1 my-10"> <div class="animate flex items-center gap-1.5"> <div class="font-base text-sm"> <time datetime="2019-12-30T16:02:13.000Z"> December 30, 2019 </time> </div> </div> <div class="animate text-2xl font-semibold text-black dark:text-white"> Avoid double payment in distributed payment env </div> <div class="animate flex flex-wrap gap-2 mt-4"> <span class="text-xs px-2 py-1 rounded bg-stone-200 dark:bg-stone-800"> distributed </span> </div> </div> <article class="animate"> <p><a href="https://medium.com/airbnb-engineering/avoiding-double-payments-in-a-distributed-payments-system-2981f6b070bb">原文链接</a></p>
<p>There are <a href="https://en.wikipedia.org/wiki/Eventual_consistency#Conflict_resolution">three different common techniques</a> used in distributed systems to achieve <a href="https://en.wikipedia.org/wiki/Eventual_consistency"><strong>eventual consistency</strong></a>: <a href="https://docs.datastax.com/en/cassandra/3.0/cassandra/operations/opsRepairNodesReadRepair.html">read repair</a>, write repair, and asynchronous repair.</p>
<p>Asynchronous repair involves the server being responsible for running  data consistency checks, such as table scans, lambda functions, and cron jobs. Additionally, asynchronous notifications from the server to the  client are widely used in the payments industry to force consistency on  the client side.</p>
<p><strong>write repair</strong>, where every write call from the client to the server attempts to repair an inconsistent, broken state.</p>
<p>By design, idempotency safely allows multiple identical calls from clients using an <strong>auto-retry mechanism</strong> for an API to achieve eventual consistency.</p>
<p>it offers low latency while still providing clean separation between  high-velocity product code and low-velocity system management code.</p>
<ul>
<li>An <strong>idempotency key</strong> is passed into the framework, representing a single idempotent request</li>
<li>Tables of idempotency information, always read and written from a <strong>sharded master</strong> database (for <a href="https://en.wikipedia.org/wiki/Consistency_(database_systems)">consistency</a>)</li>
<li>Database transactions are combined in different parts of the codebase to ensure <a href="https://en.wikipedia.org/wiki/Atomicity_(database_systems)">atomicity</a>, using <a href="https://docs.oracle.com/javase/tutorial/java/javaOO/lambdaexpressions.html">Java lambdas</a></li>
<li>Error responses are classified as “<strong>retryable</strong>” or “<strong>non-retryable</strong>“</li>
</ul>
<p>Orpheus is centered around the assumption that almost every standard API request can be separated into <strong>three distinct phases</strong>: Pre-RPC, RPC, and Post-RPC.</p>
<ol>
<li><strong>Pre-RPC:</strong> Details of the payment request are recorded in the database.</li>
<li><strong>RPC:</strong> The request is made live to the external service over network and the  response is received. This is a place to do one or more idempotent  computations or RPCs (for example, query service for the status of a  transaction first if it’s a retry-attempt).</li>
<li><strong>Post-RPC:</strong> Details of the response from the external service are recorded in the  database, including its successfulness and whether a bad request is <strong>retryable</strong> or not.</li>
</ol>
<p>To maintain data integrity, we adhere to <strong>two simple ground rules</strong>:</p>
<ol>
<li><strong>No service interaction over networks in Pre and Post-RPC phases</strong></li>
<li><strong>No database interactions in the RPC phases</strong></li>
</ol>
<p>针对pre-RPC和post-RPC的database操作进行合并。every database commit in each of the Pre-RPC and Post-RPC phases is <strong>combined into a single database transaction</strong>. This ensures atomicity — entire units of work (here the Pre-RPC and Post-RPC phases) can fail or succeed as a unit <strong>consistently</strong>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#F97583">public</span><span style="color:#E1E4E8"> Response </span><span style="color:#B392F0">processPayment</span><span style="color:#E1E4E8">(InitiatePaymentRequest request, UriInfo uriInfo)</span></span>
<span class="line"><span style="color:#E1E4E8">   throws YourCustomException {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583"> return</span><span style="color:#E1E4E8"> orpheusManager.</span><span style="color:#B392F0">process</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">     request.</span><span style="color:#B392F0">getIdempotencyKey</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">     uriInfo,</span></span>
<span class="line"><span style="color:#6A737D">     // 1. Pre-RPC</span></span>
<span class="line"><span style="color:#E1E4E8">     () </span><span style="color:#F97583">-></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">       // Record payment request information from the request object</span></span>
<span class="line"><span style="color:#E1E4E8">       PaymentRequestResource paymentRequestResource </span><span style="color:#F97583">=</span><span style="color:#B392F0"> recordPaymentRequest</span><span style="color:#E1E4E8">(request);</span></span>
<span class="line"><span style="color:#F97583">       return</span><span style="color:#E1E4E8"> Optional.</span><span style="color:#B392F0">of</span><span style="color:#E1E4E8">(paymentRequestResource);</span></span>
<span class="line"><span style="color:#E1E4E8">     },</span></span>
<span class="line"><span style="color:#6A737D">     // 2. RPC</span></span>
<span class="line"><span style="color:#E1E4E8">     (isRetry, paymentRequest) </span><span style="color:#F97583">-></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">       return</span><span style="color:#B392F0"> executePayment</span><span style="color:#E1E4E8">(paymentRequest, isRetry);</span></span>
<span class="line"><span style="color:#E1E4E8">     },</span></span>
<span class="line"><span style="color:#6A737D">     // 3. Post RPC - record response information to database</span></span>
<span class="line"><span style="color:#E1E4E8">     (isRetry, paymentResponse) </span><span style="color:#F97583">-></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">       return</span><span style="color:#B392F0"> recordPaymentResponse</span><span style="color:#E1E4E8">(paymentResponse);</span></span>
<span class="line"><span style="color:#E1E4E8">     });</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>FSM state machine</p>
<p>针对retry和noretry的情况进行分类</p>
<p><img src="https://miro.medium.com/max/3568/1*_q2kiqlR69N_Tybu37Px2Q.png" alt="retry or no-retry"></p>
<p>Choosing an idempotency key is crucial — the client can choose either to have <strong>request-level</strong> idempotency or <strong>entity-level</strong> idempotency based on what key to use.</p>
<p>each api request has an expiring lease</p>
<p>A lease comes with an expiration to cover the scenario where there are timeouts on the server side.</p>
<p>由于replica lag的问题，尽量不要使用replica database</p> </article>  </div>  </main> <footer class="animate" data-astro-cid-sz7xmlte> <div class="mx-auto max-w-screen-sm px-5">  <div class="flex justify-between items-center" data-astro-cid-sz7xmlte> <div data-astro-cid-sz7xmlte>
&copy; 2026 | Blog
</div> <div class="flex flex-wrap gap-1 items-center" data-astro-cid-sz7xmlte> <button id="light-theme-button" aria-label="Light theme" class="group size-8 flex items-center justify-center rounded-full" data-astro-cid-sz7xmlte> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="group-hover:stroke-black group-hover:dark:stroke-white transition-colors duration-300 ease-in-out" data-astro-cid-sz7xmlte> <circle cx="12" cy="12" r="5" data-astro-cid-sz7xmlte></circle> <line x1="12" y1="1" x2="12" y2="3" data-astro-cid-sz7xmlte></line> <line x1="12" y1="21" x2="12" y2="23" data-astro-cid-sz7xmlte></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" data-astro-cid-sz7xmlte></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" data-astro-cid-sz7xmlte></line> <line x1="1" y1="12" x2="3" y2="12" data-astro-cid-sz7xmlte></line> <line x1="21" y1="12" x2="23" y2="12" data-astro-cid-sz7xmlte></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" data-astro-cid-sz7xmlte></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" data-astro-cid-sz7xmlte></line> </svg> </button> <button id="dark-theme-button" aria-label="Dark theme" class="group size-8 flex items-center justify-center rounded-full" data-astro-cid-sz7xmlte> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="group-hover:stroke-black group-hover:dark:stroke-white transition-colors duration-300 ease-in-out" data-astro-cid-sz7xmlte> <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" data-astro-cid-sz7xmlte></path> </svg> </button> <button id="system-theme-button" aria-label="System theme" class="group size-8 flex items-center justify-center rounded-full" data-astro-cid-sz7xmlte> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="group-hover:stroke-black group-hover:dark:stroke-white transition-colors duration-300 ease-in-out" data-astro-cid-sz7xmlte> <rect x="2" y="3" width="20" height="14" rx="2" ry="2" data-astro-cid-sz7xmlte></rect> <line x1="8" y1="21" x2="16" y2="21" data-astro-cid-sz7xmlte></line> <line x1="12" y1="17" x2="12" y2="21" data-astro-cid-sz7xmlte></line> </svg> </button> </div> </div>  </div> </footer>  <script>
  function setTheme(theme) {
    document.documentElement.classList.remove("light", "dark", "system");
    
    if (theme === "system") {
      document.documentElement.classList.add("system");
      const systemTheme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
      document.documentElement.classList.add(systemTheme);
    } else {
      document.documentElement.classList.add(theme);
    }
    
    localStorage.setItem("theme", theme);
  }

  document.getElementById("light-theme-button")?.addEventListener("click", () => setTheme("light"));
  document.getElementById("dark-theme-button")?.addEventListener("click", () => setTheme("dark"));
  document.getElementById("system-theme-button")?.addEventListener("click", () => setTheme("system"));

  const savedTheme = localStorage.getItem("theme") || "system";
  setTheme(savedTheme);
</script>  </body> </html>