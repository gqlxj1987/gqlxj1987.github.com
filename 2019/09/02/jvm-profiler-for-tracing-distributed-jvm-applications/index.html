<!DOCTYPE html><html lang="zh-CN"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v4.16.19"><meta name="description" content="Jvm profiler for tracing distributed jvm applications"><title>Jvm profiler for tracing distributed jvm applications</title><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet"><link rel="stylesheet" href="/_astro/_title_.U5p-WJ3X.css"><script type="module">const e=()=>{document.querySelectorAll(".animate").forEach((t,s)=>{setTimeout(()=>{t.classList.add("show")},s*150)})};e();document.addEventListener("astro:after-swap",e);
</script></head> <body> <header> <div class="mx-auto max-w-screen-sm px-5">  <div class="flex flex-wrap gap-y-2 justify-between"> <a href="/" class="font-semibold hover:underline underline-offset-2">
Blog
</a> <nav class="flex gap-1">  <a href="/archive" class="hover:underline underline-offset-2"> Archive </a> <span>/</span> <a href="/tags" class="hover:underline underline-offset-2"> Tags </a> <span>/</span> <a href="/categories" class="hover:underline underline-offset-2"> Categories </a> <span>/</span> <a href="/about" class="hover:underline underline-offset-2"> About </a>  </nav> </div>  </div> </header> <main>  <div class="mx-auto max-w-screen-sm px-5">  <div class="animate"> <a href="/archive" class="hover:underline underline-offset-2">
← Back to archive
</a> </div> <div class="space-y-1 my-10"> <div class="animate flex items-center gap-1.5"> <div class="font-base text-sm"> <time datetime="2019-09-02T20:04:00.000Z"> September 2, 2019 </time> </div> </div> <div class="animate text-2xl font-semibold text-black dark:text-white"> Jvm profiler for tracing distributed jvm applications </div> <div class="animate flex flex-wrap gap-2 mt-4"> <span class="text-xs px-2 py-1 rounded bg-stone-200 dark:bg-stone-800"> jvm </span> </div> </div> <article class="animate"> <p><a href="https://eng.uber.com/jvm-profiler/">原文链接</a></p>
<p>While Spark makes data technology more accessible, right-sizing the resources allocated to Spark applications
and optimizing the operational efficiency of our data infrastructure requires more fine-grained insights about these systems, namely their resource usage patterns.</p>
<p>Our existing tools could only monitor server-level metrics and did not gauge metrics for individual applications. We needed a solution that could collect metrics for each process and correlate them across processes for each application. Additionally, we do not know when these processes will launch and how long they will take. To be able to collect metrics in this environment,
the profiler needs to be launched automatically with each process.</p>
<h4 id="what-does-the-jvm-profiler-do">What does the JVM Profiler do?</h4>
<p>The JVM Profiler is composed of three  key features that make it easier to collect performance and resource  usage metrics, and then serve these metrics (e.g. Apache Kafka) to other  systems for further analysis:</p>
<ul>
<li><strong>A java agent</strong>:  By incorporating a Java agent into our profiler, users can collect  various metrics (e.g. CPU/memory usage) and stack traces for JVM  processes in a distributed way.</li>
<li><strong>Advanced profiling capabilities</strong>:  Our JVM Profiler allows us to trace arbitrary Java methods and  arguments in the user code without making any actual code changes. This  feature can be used to trace HDFS NameNode RPC call latency for Spark  applications and identify slow method calls. It can also trace the HDFS  file paths each Spark application reads or writes to identify hot files  for further optimization.</li>
<li><strong>Data analytics reporting</strong>:  At Uber, we use the profiler to report metrics to Kafka topics and  Apache Hive tables, making data analytics faster and easier.</li>
</ul>
<h4 id="typical-use-cases">Typical use cases</h4>
<ul>
<li><strong>Right-size executor:</strong> We use  memory metrics from the JVM Profiler to track actual memory usage for  each executor so we can set the proper value for the Spark  “executor-memory” argument.</li>
<li><strong>Monitor HDFS NameNode RPC latency:</strong> We profile methods on the class <em>org.apache.hadoop.hdfs.protocolPB.ClientNamenodeProtocolTranslatorPB</em>  in a Spark application and identify long latencies on NameNode calls.  We monitor more than 50 thousand Spark applications each day with  several billions of such RPC calls.</li>
<li><strong>Monitor driver dropped events:</strong> We profile methods like <em>org.apache.spark.scheduler.LiveListenerBus.onDropEvent</em> to trace situations during which the Spark driver event queue becomes too long and drops events.</li>
<li><strong>Trace data lineage:</strong> We profile file path arguments on the method <em>org.apache.hadoop.hdfs.protocolPB.ClientNamenodeProtocolTranslatorPB.getBlockLocations</em> and <em>org.apache.hadoop.hdfs.protocolPB.ClientNamenodeProtocolTranslatorPB.addBlock</em> to trace what files are read and written by the Spark application.</li>
</ul>
<p><a href="github.com/uber-common/jvm-profiler">repo地址</a></p>
<p>入口函数为Agent.java</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> final</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> Agent</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> static</span><span style="color:#E1E4E8"> AgentImpl agentImpl </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> AgentImpl</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#B392F0"> Agent</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> static</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> agentmain</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">final</span><span style="color:#E1E4E8"> String </span><span style="color:#FFAB70">args</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">final</span><span style="color:#E1E4E8"> Instrumentation </span><span style="color:#FFAB70">instrumentation</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#B392F0">        premain</span><span style="color:#E1E4E8">(args, instrumentation);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> static</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> premain</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">final</span><span style="color:#E1E4E8"> String </span><span style="color:#FFAB70">args</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">final</span><span style="color:#E1E4E8"> Instrumentation </span><span style="color:#FFAB70">instrumentation</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">        System.out.</span><span style="color:#B392F0">println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Java Agent "</span><span style="color:#F97583"> +</span><span style="color:#E1E4E8"> AgentImpl.VERSION </span><span style="color:#F97583">+</span><span style="color:#9ECBFF"> " premain args: "</span><span style="color:#F97583"> +</span><span style="color:#E1E4E8"> args);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">        Arguments arguments </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Arguments.</span><span style="color:#B392F0">parseArgs</span><span style="color:#E1E4E8">(args);</span></span>
<span class="line"><span style="color:#E1E4E8">        arguments.</span><span style="color:#B392F0">runConfigProvider</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">        agentImpl.</span><span style="color:#B392F0">run</span><span style="color:#E1E4E8">(arguments, instrumentation, </span><span style="color:#79B8FF">null</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </article>  </div>  </main> <footer class="animate" data-astro-cid-sz7xmlte> <div class="mx-auto max-w-screen-sm px-5">  <div class="flex justify-between items-center" data-astro-cid-sz7xmlte> <div data-astro-cid-sz7xmlte>
&copy; 2026 | Blog
</div> <div class="flex flex-wrap gap-1 items-center" data-astro-cid-sz7xmlte> <button id="light-theme-button" aria-label="Light theme" class="group size-8 flex items-center justify-center rounded-full" data-astro-cid-sz7xmlte> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="group-hover:stroke-black group-hover:dark:stroke-white transition-colors duration-300 ease-in-out" data-astro-cid-sz7xmlte> <circle cx="12" cy="12" r="5" data-astro-cid-sz7xmlte></circle> <line x1="12" y1="1" x2="12" y2="3" data-astro-cid-sz7xmlte></line> <line x1="12" y1="21" x2="12" y2="23" data-astro-cid-sz7xmlte></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" data-astro-cid-sz7xmlte></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" data-astro-cid-sz7xmlte></line> <line x1="1" y1="12" x2="3" y2="12" data-astro-cid-sz7xmlte></line> <line x1="21" y1="12" x2="23" y2="12" data-astro-cid-sz7xmlte></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" data-astro-cid-sz7xmlte></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" data-astro-cid-sz7xmlte></line> </svg> </button> <button id="dark-theme-button" aria-label="Dark theme" class="group size-8 flex items-center justify-center rounded-full" data-astro-cid-sz7xmlte> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="group-hover:stroke-black group-hover:dark:stroke-white transition-colors duration-300 ease-in-out" data-astro-cid-sz7xmlte> <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" data-astro-cid-sz7xmlte></path> </svg> </button> <button id="system-theme-button" aria-label="System theme" class="group size-8 flex items-center justify-center rounded-full" data-astro-cid-sz7xmlte> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="group-hover:stroke-black group-hover:dark:stroke-white transition-colors duration-300 ease-in-out" data-astro-cid-sz7xmlte> <rect x="2" y="3" width="20" height="14" rx="2" ry="2" data-astro-cid-sz7xmlte></rect> <line x1="8" y1="21" x2="16" y2="21" data-astro-cid-sz7xmlte></line> <line x1="12" y1="17" x2="12" y2="21" data-astro-cid-sz7xmlte></line> </svg> </button> </div> </div>  </div> </footer>  <script>
  function setTheme(theme) {
    document.documentElement.classList.remove("light", "dark", "system");
    
    if (theme === "system") {
      document.documentElement.classList.add("system");
      const systemTheme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
      document.documentElement.classList.add(systemTheme);
    } else {
      document.documentElement.classList.add(theme);
    }
    
    localStorage.setItem("theme", theme);
  }

  document.getElementById("light-theme-button")?.addEventListener("click", () => setTheme("light"));
  document.getElementById("dark-theme-button")?.addEventListener("click", () => setTheme("dark"));
  document.getElementById("system-theme-button")?.addEventListener("click", () => setTheme("system"));

  const savedTheme = localStorage.getItem("theme") || "system";
  setTheme(savedTheme);
</script>  </body> </html>