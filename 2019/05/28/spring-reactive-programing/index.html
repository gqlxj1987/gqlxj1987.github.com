<!DOCTYPE html><html lang="zh-CN"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v4.16.19"><title>Blog</title><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono&display=swap" rel="stylesheet"><style>:root{--primary: #2563eb;--text-main: #1f2937;--text-muted: #6b7280;--bg-main: #ffffff;--bg-secondary: #f9fafb;--border: #e5e7eb;--max-width: 800px;--font-sans: "Inter", system-ui, -apple-system, sans-serif;--font-mono: "JetBrains Mono", monospace}*{margin:0;padding:0;box-sizing:border-box}body{font-family:var(--font-sans);color:var(--text-main);background-color:var(--bg-main);line-height:1.6;-webkit-font-smoothing:antialiased}.app-container{display:flex;flex-direction:column;min-height:100vh}.navbar{border-bottom:1px solid var(--border);position:sticky;top:0;background:#fffc;backdrop-filter:blur(8px);z-index:100}.nav-content{max-width:var(--max-width);margin:0 auto;padding:1rem;display:flex;justify-content:space-between;align-items:center}.logo{text-decoration:none;color:var(--text-main);font-weight:800;font-size:1.5rem}.nav-links{list-style:none;display:flex;gap:1.5rem}.nav-links a{text-decoration:none;color:var(--text-muted);font-size:.95rem;font-weight:500;transition:color .2s}.nav-links a:hover{color:var(--primary)}.main-content{flex:1;max-width:var(--max-width);margin:0 auto;width:100%;padding:3rem 1rem}.footer{border-top:1px solid var(--border);background:var(--bg-secondary);padding:2rem 1rem;margin-top:4rem}.footer-content{max-width:var(--max-width);margin:0 auto;text-align:center;color:var(--text-muted);font-size:.9rem}.post-content h1,.post-content h2,.post-content h3{margin-top:2.5rem;margin-bottom:1rem;line-height:1.3}.post-content p{margin-bottom:1.5rem}.post-content img{max-width:100%;height:auto;border-radius:8px;margin:2rem 0}.post-content pre{border-radius:8px;padding:1.25rem;margin-bottom:2rem;font-family:var(--font-mono);font-size:.9rem;overflow-x:auto}.post-content code:not(pre code){background:var(--bg-secondary);padding:.2rem .4rem;border-radius:4px;font-family:var(--font-mono);font-size:.9em}.post-content blockquote{border-left:4px solid var(--primary);padding-left:1.5rem;font-style:italic;color:var(--text-muted);margin:2rem 0}.post-content ul,.post-content ol{margin-bottom:1.5rem;padding-left:1.5rem}.post-content li{margin-bottom:.5rem}
.post-header[data-astro-cid-rl3favg5]{margin-bottom:4rem;text-align:center}.post-date[data-astro-cid-rl3favg5]{display:block;font-size:.875rem;text-transform:uppercase;letter-spacing:.05em;color:var(--text-muted);font-weight:600;margin-bottom:1rem}.post-title[data-astro-cid-rl3favg5]{font-size:3rem;font-weight:800;line-height:1.1;margin-bottom:1.5rem;letter-spacing:-.025em}.post-meta[data-astro-cid-rl3favg5]{display:flex;justify-content:center;gap:1.5rem;font-size:.95rem;color:var(--text-muted)}.tag[data-astro-cid-rl3favg5]{color:var(--primary);margin-right:.5rem}@media (max-width: 640px){.post-title[data-astro-cid-rl3favg5]{font-size:2rem}}
</style></head> <body> <div class="app-container"> <header class="navbar"> <div class="nav-content"> <a href="/" class="logo"> <span class="logo-text">Blog</span> </a> <nav> <ul class="nav-links"> <li><a href="/">Home</a></li> <li><a href="/archive">Archive</a></li> <li><a href="/about">About</a></li> </ul> </nav> </div> </header> <main class="main-content">  <article class="post" data-astro-cid-rl3favg5> <header class="post-header" data-astro-cid-rl3favg5> <time class="post-date" data-astro-cid-rl3favg5> May 28, 2019 </time> <h1 class="post-title" data-astro-cid-rl3favg5></h1> <div class="post-meta" data-astro-cid-rl3favg5>   </div> </header> <div class="post-content" data-astro-cid-rl3favg5> <h2 id="title--spring-reactive-programingdate--2019-05-28-200241categories--springtags--reactive-spring">title : Spring Reactive Programing
date : 2019-05-28 20:02:41
categories : spring
tags : [reactive, spring]</h2>
<p><a href="https://skyscribe.github.io/post/2018/04/04/spring-reactive/">原文链接</a></p>
<p>FRP的程序，程序的<strong>主要逻辑不需要再关注底层的操作是怎么被调度的，而仅仅关心一个一个具体的操作应该做什么，互相配合</strong>完成系统目标。这个角度来说，FRP的方式是声明式的；而声明式的代码相对传统的过程式代码有更好的可读性和可维护性。</p>
<p>GoF在设计模式里面特别声明了我们需要考虑优先使用组合而不是继承，不幸的是这一忠告从来就没有被人们认真对待; FRP的思维方式完全不提继承的事儿，但是封装依然是必要的；组合则被提到了首要的位置，因为函数式编程的主要复用方式就是组合</p>
<p>传统的Spring MVC框架工作机制如下</p>
<ol>
<li><code>DispatcherServelet</code> 会搜索<code>WebApplicationContext</code>来查找DI容器中注册的Controller以处理进来的HTTP请求</li>
<li>本地化解析的Bean在这一过程中也会被一并查找并关联起来以便后续渲染View的时候使用来本地化View中的显示内容</li>
<li>主题解析的Bean则被用来关联后续要使用的View模板,以进行CSS渲染等额外处理</li>
<li>如果HTTP请求包含多部分媒体内容，那么请求会被封装在一个<code>MultipartHttpServeletRequest</code>中处理</li>
<li>Dispatcher会搜索对应的Handler，找到之后，handler对应的controller以及其前置处理、后续处理会被按照顺序依次处理以准备模型返回，或者被用于后续View渲染</li>
<li>如果一个模型被返回，对应的View就会被渲染并返回响应的HTTP消息 整体的处理逻辑是一个线性的同步处理逻辑。</li>
</ol>
<p>传统的Sping MVC框架的接口都定义在 <code>org.springframework.web.servlet</code>包中，而支持响应式编程的Web框架被命名为WebFlux,对应的接口和注解放在一个新的Java包中：<code>org.springframework.web.reactive</code>。它是全异步、非阻塞的</p>
<p><code>Mono</code>或者<code>Flux</code>对象概念有些类似于Java8中的<code>CompletableFuture</code>,自身支持类似的lambda表达式组合来实现流式操作。这两个类型本质上实现了Reactive Stream中的<code>Publish</code>的概念，可以认为它是流的发布者。</p>
<p><code>Flux</code>和<code>Mono</code>的不同是，它本身会产生0到N个事件输出到流中；然后才最终完成或者报错。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#E1E4E8"># netty</span></span>
<span class="line"><span style="color:#E1E4E8">HttpHandler handler </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> ...</span></span>
<span class="line"><span style="color:#E1E4E8">ReactorHttpHandlerAdapter adapter </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> ReactorHttpHandlerAdapter</span><span style="color:#E1E4E8">(handler);</span></span>
<span class="line"><span style="color:#E1E4E8">HttpServer.</span><span style="color:#B392F0">create</span><span style="color:#E1E4E8">(host, port).</span><span style="color:#B392F0">newHandler</span><span style="color:#E1E4E8">(adapter).</span><span style="color:#B392F0">block</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">#jetty</span></span>
<span class="line"><span style="color:#E1E4E8">HttpHandler handler </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> ...</span></span>
<span class="line"><span style="color:#E1E4E8">Servlet servlet </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> JettyHttpHandlerAdapter</span><span style="color:#E1E4E8">(handler);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">Server server </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Server</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">ServletContextHandler contextHandler </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> ServletContextHandler</span><span style="color:#E1E4E8">(server, </span><span style="color:#9ECBFF">""</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">contextHandler.</span><span style="color:#B392F0">addServlet</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">new</span><span style="color:#B392F0"> ServletHolder</span><span style="color:#E1E4E8">(servlet), </span><span style="color:#9ECBFF">"/"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">contextHandler.</span><span style="color:#B392F0">start</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">ServerConnector connector </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> ServerConnector</span><span style="color:#E1E4E8">(server);</span></span>
<span class="line"><span style="color:#E1E4E8">connector.</span><span style="color:#B392F0">setHost</span><span style="color:#E1E4E8">(host);</span></span>
<span class="line"><span style="color:#E1E4E8">connector.</span><span style="color:#B392F0">setPort</span><span style="color:#E1E4E8">(port);</span></span>
<span class="line"><span style="color:#E1E4E8">server.</span><span style="color:#B392F0">addConnector</span><span style="color:#E1E4E8">(connector);</span></span>
<span class="line"><span style="color:#E1E4E8">server.</span><span style="color:#B392F0">start</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span></code></pre>
<p>将返回值的处理与路由进行分离</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> PersonHandler</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> final</span><span style="color:#E1E4E8"> PersonRepository repository;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#B392F0"> PersonHandler</span><span style="color:#E1E4E8">(PersonRepository </span><span style="color:#FFAB70">repository</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#79B8FF">        this</span><span style="color:#E1E4E8">.repository </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> repository;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#E1E4E8"> Mono&#x3C;</span><span style="color:#F97583">ServerResponse</span><span style="color:#E1E4E8">> </span><span style="color:#B392F0">listPeople</span><span style="color:#E1E4E8">(ServerRequest </span><span style="color:#FFAB70">request</span><span style="color:#E1E4E8">) { </span></span>
<span class="line"><span style="color:#E1E4E8">        Flux&#x3C;</span><span style="color:#F97583">Person</span><span style="color:#E1E4E8">> people </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> repository.</span><span style="color:#B392F0">allPeople</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> ServerResponse.</span><span style="color:#B392F0">ok</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">contentType</span><span style="color:#E1E4E8">(APPLICATION_JSON).</span><span style="color:#B392F0">body</span><span style="color:#E1E4E8">(people, Person.class);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#E1E4E8"> Mono&#x3C;</span><span style="color:#F97583">ServerResponse</span><span style="color:#E1E4E8">> </span><span style="color:#B392F0">createPerson</span><span style="color:#E1E4E8">(ServerRequest </span><span style="color:#FFAB70">request</span><span style="color:#E1E4E8">) { </span></span>
<span class="line"><span style="color:#E1E4E8">        Mono&#x3C;</span><span style="color:#F97583">Person</span><span style="color:#E1E4E8">> person </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> request.</span><span style="color:#B392F0">bodyToMono</span><span style="color:#E1E4E8">(Person.class);</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> ServerResponse.</span><span style="color:#B392F0">ok</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">build</span><span style="color:#E1E4E8">(repository.</span><span style="color:#B392F0">savePerson</span><span style="color:#E1E4E8">(person));</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#E1E4E8"> Mono&#x3C;</span><span style="color:#F97583">ServerResponse</span><span style="color:#E1E4E8">> </span><span style="color:#B392F0">getPerson</span><span style="color:#E1E4E8">(ServerRequest </span><span style="color:#FFAB70">request</span><span style="color:#E1E4E8">) { </span></span>
<span class="line"><span style="color:#F97583">        int</span><span style="color:#E1E4E8"> personId </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Integer.</span><span style="color:#B392F0">valueOf</span><span style="color:#E1E4E8">(request.</span><span style="color:#B392F0">pathVariable</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"id"</span><span style="color:#E1E4E8">));</span></span>
<span class="line"><span style="color:#E1E4E8">        Mono&#x3C;</span><span style="color:#F97583">ServerResponse</span><span style="color:#E1E4E8">> notFound </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> ServerResponse.</span><span style="color:#B392F0">notFound</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">build</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">        Mono&#x3C;</span><span style="color:#F97583">Person</span><span style="color:#E1E4E8">> personMono </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.repository.</span><span style="color:#B392F0">getPerson</span><span style="color:#E1E4E8">(personId);</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> personMono</span></span>
<span class="line"><span style="color:#E1E4E8">            .</span><span style="color:#B392F0">flatMap</span><span style="color:#E1E4E8">(person </span><span style="color:#F97583">-></span><span style="color:#E1E4E8"> ServerResponse.</span><span style="color:#B392F0">ok</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">contentType</span><span style="color:#E1E4E8">(APPLICATION_JSON).</span><span style="color:#B392F0">body</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">fromObject</span><span style="color:#E1E4E8">(person)))</span></span>
<span class="line"><span style="color:#E1E4E8">            .</span><span style="color:#B392F0">switchIfEmpty</span><span style="color:#E1E4E8">(notFound);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8"># router</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">PersonRepository repository </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> ...</span></span>
<span class="line"><span style="color:#E1E4E8">PersonHandler handler </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> PersonHandler</span><span style="color:#E1E4E8">(repository);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">RouterFunction&#x3C;</span><span style="color:#F97583">ServerResponse</span><span style="color:#E1E4E8">> personRoute </span><span style="color:#F97583">=</span></span>
<span class="line"><span style="color:#B392F0">    route</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">GET</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"/person/{id}"</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">and</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">accept</span><span style="color:#E1E4E8">(APPLICATION_JSON)), handler</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">getPerson)</span></span>
<span class="line"><span style="color:#E1E4E8">        .</span><span style="color:#B392F0">andRoute</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">GET</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"/person"</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">and</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">accept</span><span style="color:#E1E4E8">(APPLICATION_JSON)), handler</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">listPeople)</span></span>
<span class="line"><span style="color:#E1E4E8">        .</span><span style="color:#B392F0">andRoute</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">POST</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"/person"</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">and</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">contentType</span><span style="color:#E1E4E8">(APPLICATION_JSON)), handler</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">createPerson);</span></span>
<span class="line"></span></code></pre> </div> </article>  </main> <footer class="footer"> <div class="footer-content"> <p>&copy; 2026 Liu Weifeng. Built with Astro.</p> </div> </footer> </div> </body></html> 